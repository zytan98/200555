{"ast":null,"code":"function _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n\n  return _typeof(obj);\n}\n\nimport { __awaiter, __extends, __generator } from \"tslib\";\nimport { AbstractLayout } from '@antv/g6-core';\nimport { Layout } from '../../layout';\nimport { LayoutWorker } from '../../layout/worker/layout.worker';\nimport { LAYOUT_MESSAGE } from '../../layout/worker/layoutConst';\nimport { gpuDetector } from '../../util/gpu';\nimport { mix, clone } from '@antv/util'; // eslint-disable-next-line @typescript-eslint/no-implied-eval\n\nvar mockRaf = function mockRaf(cb) {\n  return setTimeout(cb, 16);\n};\n\nvar mockCaf = function mockCaf(reqId) {\n  return clearTimeout(reqId);\n};\n\nvar helper = {\n  // pollyfill\n  requestAnimationFrame: function requestAnimationFrame(callback) {\n    var fn = typeof window !== 'undefined' ? window.requestAnimationFrame || window.webkitRequestAnimationFrame || mockRaf : mockRaf;\n    return fn(callback);\n  },\n  cancelAnimationFrame: function cancelAnimationFrame(requestId) {\n    var fn = typeof window !== 'undefined' ? window.cancelAnimationFrame || window.webkitCancelAnimationFrame || mockCaf : mockCaf;\n    return fn(requestId);\n  }\n};\nvar GPULayoutNames = ['fruchterman', 'gForce'];\nvar LayoutPipesAdjustNames = ['force', 'grid', 'circular'];\n\nvar LayoutController =\n/** @class */\nfunction (_super) {\n  __extends(LayoutController, _super); // the configurations of the layout\n  // private layoutCfg: any; // LayoutOptions\n  // the type name of the layout\n  // private layoutType: string;\n  // private data: GraphData;\n  // private layoutMethods: typeof Layout;\n\n\n  function LayoutController(graph) {\n    var _this = _super.call(this, graph) || this;\n\n    _this.graph = graph;\n    _this.layoutCfg = graph.get('layout') || {};\n    _this.layoutType = _this.getLayoutType();\n    _this.worker = null;\n    _this.workerData = {};\n\n    _this.initLayout();\n\n    return _this;\n  } // eslint-disable-next-line class-methods-use-this\n\n\n  LayoutController.prototype.initLayout = function () {// no data before rendering\n  }; // get layout worker and create one if not exists\n\n\n  LayoutController.prototype.getWorker = function () {\n    if (this.worker) {\n      return this.worker;\n    }\n\n    if (typeof Worker === 'undefined') {\n      // 如果当前浏览器不支持 web worker，则不使用 web worker\n      console.warn('Web worker is not supported in current browser.');\n      this.worker = null;\n    } else {\n      this.worker = LayoutWorker(this.layoutCfg.workerScriptURL);\n    }\n\n    return this.worker;\n  }; // stop layout worker\n\n\n  LayoutController.prototype.stopWorker = function () {\n    var workerData = this.workerData;\n\n    if (!this.worker) {\n      return;\n    }\n\n    this.worker.terminate();\n    this.worker = null; // 重新开始新的布局之前，先取消之前布局的requestAnimationFrame。\n\n    if (workerData.requestId) {\n      helper.cancelAnimationFrame(workerData.requestId);\n      workerData.requestId = null;\n    }\n\n    if (workerData.requestId2) {\n      helper.cancelAnimationFrame(workerData.requestId2);\n      workerData.requestId2 = null;\n    }\n  };\n\n  LayoutController.prototype.execLayoutMethod = function (layoutCfg, order) {\n    var _this = this;\n\n    return new Promise(function (reslove, reject) {\n      var graph = _this.graph;\n      var layoutType = layoutCfg.type; // 每个布局方法都需要注册\n\n      layoutCfg.onLayoutEnd = function () {\n        graph.emit('aftersublayout', {\n          type: layoutType\n        });\n        reslove();\n      }; // 若用户指定开启 gpu，且当前浏览器支持 webgl，且该算法存在 GPU 版本（目前仅支持 fruchterman 和 gForce），使用 gpu 版本的布局\n\n\n      if (layoutType && _this.isGPU) {\n        if (!_this.hasGPUVersion(layoutType)) {\n          console.warn(\"The '\" + layoutType + \"' layout does not support GPU calculation for now, it will run in CPU.\");\n        } else {\n          layoutType = layoutType + \"-gpu\";\n        }\n      }\n\n      var isForce = layoutType === 'force' || layoutType === 'g6force' || layoutType === 'gForce';\n\n      if (isForce) {\n        var onTick_1 = layoutCfg.onTick;\n\n        var tick = function tick() {\n          if (onTick_1) {\n            onTick_1();\n          }\n\n          graph.refreshPositions();\n        };\n\n        layoutCfg.tick = tick;\n      } else if (layoutCfg.type === 'comboForce') {\n        layoutCfg.comboTrees = graph.get('comboTrees');\n      }\n\n      var enableTick = false;\n      var layoutMethod;\n\n      try {\n        layoutMethod = new Layout[layoutType](layoutCfg);\n      } catch (e) {\n        console.warn(\"The layout method: '\" + layoutType + \"' does not exist! Please specify it first.\");\n        reject();\n      } // 是否需要迭代的方式完成布局。这里是来自布局对象的实例属性，是由布局的定义者在布局类定义的。\n\n\n      enableTick = layoutMethod.enableTick;\n\n      if (enableTick) {\n        var onTick_2 = layoutCfg.onTick;\n\n        var tick = function tick() {\n          if (onTick_2) {\n            onTick_2();\n          }\n\n          graph.refreshPositions();\n        };\n\n        layoutMethod.tick = tick;\n      }\n\n      var layoutData = _this.filterLayoutData(_this.data, layoutCfg);\n\n      addLayoutOrder(layoutData, order);\n      layoutMethod.init(layoutData); // 若存在节点没有位置信息，且没有设置 layout，在 initPositions 中 random 给出了所有节点的位置，不需要再次执行 random 布局\n      // 所有节点都有位置信息，且指定了 layout，则执行布局（代表不是第一次进行布局）\n\n      graph.emit('beforesublayout', {\n        type: layoutType\n      });\n      layoutMethod.execute();\n      if (layoutMethod.isCustomLayout && layoutCfg.onLayoutEnd) layoutCfg.onLayoutEnd();\n\n      _this.layoutMethods.push(layoutMethod);\n    });\n  };\n\n  LayoutController.prototype.updateLayoutMethod = function (layoutMethod, layoutCfg) {\n    var _this = this;\n\n    return new Promise(function (reslove, reject) {\n      var graph = _this.graph;\n      var layoutType = layoutCfg === null || layoutCfg === void 0 ? void 0 : layoutCfg.type; // 每个布局方法都需要注册\n\n      layoutCfg.onLayoutEnd = function () {\n        graph.emit('aftersublayout', {\n          type: layoutType\n        });\n        reslove();\n      };\n\n      var layoutData = _this.filterLayoutData(_this.data, layoutCfg);\n\n      layoutMethod.init(layoutData);\n      layoutMethod.updateCfg(layoutCfg);\n      graph.emit('beforesublayout', {\n        type: layoutType\n      });\n      layoutMethod.execute();\n      if (layoutMethod.isCustomLayout && layoutCfg.onLayoutEnd) layoutCfg.onLayoutEnd();\n    });\n  };\n  /**\n   * @param {function} success callback\n   * @return {boolean} 是否使用web worker布局\n   */\n\n\n  LayoutController.prototype.layout = function (success) {\n    var _this = this;\n\n    var graph = this.graph;\n    this.data = this.setDataFromGraph();\n    var _a = this.data,\n        nodes = _a.nodes,\n        hiddenNodes = _a.hiddenNodes;\n\n    if (!nodes) {\n      return false;\n    }\n\n    var width = graph.get('width');\n    var height = graph.get('height');\n    var layoutCfg = {};\n    Object.assign(layoutCfg, {\n      width: width,\n      height: height,\n      center: [width / 2, height / 2]\n    }, this.layoutCfg);\n    this.layoutCfg = layoutCfg;\n    this.destoryLayoutMethods();\n    graph.emit('beforelayout');\n    this.initPositions(layoutCfg.center, nodes); // init hidden ndoes\n\n    this.initPositions(layoutCfg.center, hiddenNodes); // 防止用户直接用 -gpu 结尾指定布局\n\n    var layoutType = layoutCfg.type;\n\n    if (layoutType && layoutType.split('-')[1] === 'gpu') {\n      layoutType = layoutType.split('-')[0];\n      layoutCfg.gpuEnabled = true;\n    } // 若用户指定开启 gpu，且当前浏览器支持 webgl，且该算法存在 GPU 版本（目前仅支持 fruchterman 和 gForce），使用 gpu 版本的布局\n\n\n    var enableGPU = false;\n\n    if (layoutCfg.gpuEnabled) {\n      enableGPU = true; // 打开下面语句将会导致 webworker 报找不到 window\n\n      if (!gpuDetector().webgl) {\n        console.warn(\"Your browser does not support webGL or GPGPU. The layout will run in CPU.\");\n        enableGPU = false;\n      }\n    }\n\n    this.isGPU = enableGPU; // 在 onAllLayoutEnd 中执行用户自定义 onLayoutEnd，触发 afterlayout、更新节点位置、fitView/fitCenter、触发 afterrender\n\n    var onLayoutEnd = layoutCfg.onLayoutEnd,\n        layoutEndFormatted = layoutCfg.layoutEndFormatted,\n        adjust = layoutCfg.adjust;\n\n    if (!layoutEndFormatted) {\n      layoutCfg.layoutEndFormatted = true;\n\n      layoutCfg.onAllLayoutEnd = function () {\n        return __awaiter(_this, void 0, void 0, function () {\n          return __generator(this, function (_a) {\n            switch (_a.label) {\n              case 0:\n                // 执行用户自定义 onLayoutEnd\n                if (onLayoutEnd) {\n                  onLayoutEnd();\n                } // 更新节点位置\n\n\n                this.refreshLayout();\n                if (!(adjust && layoutCfg.pipes)) return [3\n                /*break*/\n                , 2];\n                return [4\n                /*yield*/\n                , this.adjustPipesBox(this.data, adjust)];\n\n              case 1:\n                _a.sent();\n\n                this.refreshLayout();\n                _a.label = 2;\n\n              case 2:\n                // 触发 afterlayout\n                graph.emit('afterlayout');\n                return [2\n                /*return*/\n                ];\n            }\n          });\n        });\n      };\n    }\n\n    this.stopWorker();\n\n    if (layoutCfg.workerEnabled && this.layoutWithWorker(this.data)) {\n      // 如果启用布局web worker并且浏览器支持web worker，用web worker布局。否则回退到不用web worker布局。\n      return true;\n    }\n\n    var start = Promise.resolve();\n\n    if (layoutCfg.type) {\n      start = start.then(function () {\n        return _this.execLayoutMethod(layoutCfg, 0);\n      });\n    } else if (layoutCfg.pipes) {\n      layoutCfg.pipes.forEach(function (cfg, index) {\n        start = start.then(function () {\n          return _this.execLayoutMethod(cfg, index);\n        });\n      });\n    } // 最后统一在外部调用onAllLayoutEnd\n\n\n    start.then(function () {\n      if (layoutCfg.onAllLayoutEnd) layoutCfg.onAllLayoutEnd(); // 在执行 execute 后立即执行 success，且在 timeBar 中有 throttle，可以防止 timeBar 监听 afterrender 进行 changeData 后 layout，从而死循环\n      // 对于 force 一类布局完成后的 fitView 需要用户自己在 onLayoutEnd 中配置\n\n      if (success) success();\n    }).catch(function (error) {\n      console.warn('graph layout failed,', error);\n    });\n    return false;\n  };\n  /**\n   * layout with web worker\n   * @param {object} data graph data\n   * @return {boolean} 是否支持web worker\n   */\n\n\n  LayoutController.prototype.layoutWithWorker = function (data) {\n    var _this = this;\n\n    var _a = this,\n        layoutCfg = _a.layoutCfg,\n        graph = _a.graph;\n\n    var worker = this.getWorker(); // 每次worker message event handler调用之间的共享数据，会被修改。\n\n    var workerData = this.workerData;\n\n    if (!worker) {\n      return false;\n    }\n\n    workerData.requestId = null;\n    workerData.requestId2 = null;\n    workerData.currentTick = null;\n    workerData.currentTickData = null;\n    graph.emit('beforelayout');\n    var start = Promise.resolve();\n\n    if (layoutCfg.type) {\n      start = start.then(function () {\n        return _this.runWebworker(worker, data, layoutCfg);\n      });\n    } else if (layoutCfg.pipes) {\n      var _loop_1 = function _loop_1(cfg) {\n        start = start.then(function () {\n          return _this.runWebworker(worker, data, cfg);\n        });\n      };\n\n      for (var _i = 0, _b = layoutCfg.pipes; _i < _b.length; _i++) {\n        var cfg = _b[_i];\n\n        _loop_1(cfg);\n      }\n    } // 最后统一在外部调用onAllLayoutEnd\n\n\n    start.then(function () {\n      if (layoutCfg.onAllLayoutEnd) layoutCfg.onAllLayoutEnd();\n    }).catch(function (error) {\n      console.error('layout failed', error);\n    });\n    return true;\n  };\n\n  LayoutController.prototype.runWebworker = function (worker, allData, layoutCfg) {\n    var _this = this;\n\n    var isGPU = this.isGPU;\n    var data = this.filterLayoutData(allData, layoutCfg);\n    var nodes = data.nodes,\n        edges = data.edges;\n    var offScreenCanvas = document.createElement('canvas');\n    var gpuWorkerAbility = isGPU && typeof window !== 'undefined' && // eslint-disable-next-line @typescript-eslint/dot-notation\n    window.navigator && !navigator[\"gpu\"] && // WebGPU 还不支持 OffscreenCanvas\n    'OffscreenCanvas' in window && 'transferControlToOffscreen' in offScreenCanvas; // NOTE: postMessage的message参数里面不能包含函数，否则postMessage会报错，\n    // 例如：'function could not be cloned'。\n    // 详情参考：https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm\n    // 所以这里需要把过滤layoutCfg里的函数字段过滤掉。\n\n    var filteredLayoutCfg = filterObject(layoutCfg, function (value) {\n      return typeof value !== 'function';\n    });\n\n    if (!gpuWorkerAbility) {\n      worker.postMessage({\n        type: LAYOUT_MESSAGE.RUN,\n        nodes: nodes,\n        edges: edges,\n        layoutCfg: filteredLayoutCfg\n      });\n    } else {\n      var offscreen = offScreenCanvas.transferControlToOffscreen(); // filteredLayoutCfg.canvas = offscreen;\n\n      filteredLayoutCfg.type = filteredLayoutCfg.type + \"-gpu\";\n      worker.postMessage({\n        type: LAYOUT_MESSAGE.GPURUN,\n        nodes: nodes,\n        edges: edges,\n        layoutCfg: filteredLayoutCfg,\n        canvas: offscreen\n      }, [offscreen]);\n    }\n\n    return new Promise(function (reslove, reject) {\n      worker.onmessage = function (event) {\n        _this.handleWorkerMessage(reslove, reject, event, data, layoutCfg);\n      };\n    });\n  }; // success callback will be called when updating graph positions for the first time.\n\n\n  LayoutController.prototype.handleWorkerMessage = function (reslove, reject, event, data, layoutCfg) {\n    var _a = this,\n        graph = _a.graph,\n        workerData = _a.workerData;\n\n    var eventData = event.data;\n    var type = eventData.type;\n\n    var onTick = function onTick() {\n      if (layoutCfg.onTick) {\n        layoutCfg.onTick();\n      }\n    };\n\n    switch (type) {\n      case LAYOUT_MESSAGE.TICK:\n        workerData.currentTick = eventData.currentTick;\n        workerData.currentTickData = eventData;\n\n        if (!workerData.requestId) {\n          workerData.requestId = helper.requestAnimationFrame(function requestId() {\n            updateLayoutPosition(data, eventData);\n            graph.refreshPositions();\n            onTick();\n\n            if (eventData.currentTick === eventData.totalTicks) {\n              // 如果是最后一次tick\n              reslove();\n            } else if (workerData.currentTick === eventData.totalTicks) {\n              // 注意这里workerData.currentTick可能已经不再是前面赋值时候的值了，\n              // 因为在requestAnimationFrame等待时间里，可能产生新的tick。\n              // 如果当前tick不是最后一次tick，并且所有的tick消息都已发出来了，那么需要用最后一次tick的数据再刷新一次。\n              workerData.requestId2 = helper.requestAnimationFrame(function requestId2() {\n                updateLayoutPosition(data, workerData.currentTickData);\n                graph.refreshPositions();\n                workerData.requestId2 = null;\n                onTick();\n                reslove();\n              });\n            }\n\n            workerData.requestId = null;\n          });\n        }\n\n        break;\n\n      case LAYOUT_MESSAGE.END:\n        // 如果没有tick消息（非力导布局）\n        if (workerData.currentTick == null) {\n          updateLayoutPosition(data, eventData);\n          reslove();\n        }\n\n        break;\n\n      case LAYOUT_MESSAGE.GPUEND:\n        // 如果没有tick消息（非力导布局）\n        if (workerData.currentTick == null) {\n          updateGPUWorkerLayoutPosition(data, eventData);\n          reslove();\n        }\n\n        break;\n\n      case LAYOUT_MESSAGE.ERROR:\n        console.warn('Web-Worker layout error!', eventData.message);\n        reject();\n        break;\n\n      default:\n        reject();\n        break;\n    }\n  }; // 更新布局参数\n\n\n  LayoutController.prototype.updateLayoutCfg = function (cfg) {\n    var _this = this;\n\n    var _a = this,\n        graph = _a.graph,\n        layoutMethods = _a.layoutMethods;\n\n    var layoutCfg = mix({}, this.layoutCfg, cfg);\n    this.layoutCfg = layoutCfg;\n\n    if (!(layoutMethods === null || layoutMethods === void 0 ? void 0 : layoutMethods.length)) {\n      this.layout();\n      return;\n    }\n\n    this.data = this.setDataFromGraph();\n    this.stopWorker();\n\n    if (cfg.workerEnabled && this.layoutWithWorker(this.data)) {\n      // 如果启用布局web worker并且浏览器支持web worker，用web worker布局。否则回退到不用web worker布局。\n      return;\n    }\n\n    graph.emit('beforelayout');\n    var start = Promise.resolve();\n\n    if (layoutMethods.length === 1) {\n      start = start.then(function () {\n        return _this.updateLayoutMethod(layoutMethods[0], layoutCfg);\n      });\n    } else {\n      layoutMethods === null || layoutMethods === void 0 ? void 0 : layoutMethods.forEach(function (layoutMethod, index) {\n        var currentCfg = layoutCfg.pipes[index];\n        start = start.then(function () {\n          return _this.updateLayoutMethod(layoutMethod, currentCfg);\n        });\n      });\n    }\n\n    start.then(function () {\n      if (layoutCfg.onAllLayoutEnd) layoutCfg.onAllLayoutEnd();\n    }).catch(function (error) {\n      console.warn('layout failed', error);\n    });\n  };\n\n  LayoutController.prototype.adjustPipesBox = function (data, adjust) {\n    var _this = this;\n\n    return new Promise(function (resolve) {\n      var nodes = data.nodes;\n\n      if (!(nodes === null || nodes === void 0 ? void 0 : nodes.length)) {\n        resolve();\n      }\n\n      if (!LayoutPipesAdjustNames.includes(adjust)) {\n        console.warn(\"The adjust type \" + adjust + \" is not supported yet, please assign it with 'force', 'grid', or 'circular'.\");\n        resolve();\n      }\n\n      var layoutCfg = {\n        center: _this.layoutCfg.center,\n        nodeSize: function nodeSize(d) {\n          return Math.max(d.height, d.width);\n        },\n        preventOverlap: true,\n        onLayoutEnd: function onLayoutEnd() {}\n      }; // 计算出大单元\n\n      var _a = _this.getLayoutBBox(nodes),\n          groupNodes = _a.groupNodes,\n          layoutNodes = _a.layoutNodes;\n\n      var preNodes = clone(layoutNodes); // 根据大单元坐标的变化，调整这里面每个小单元nodes\n\n      layoutCfg.onLayoutEnd = function () {\n        layoutNodes === null || layoutNodes === void 0 ? void 0 : layoutNodes.forEach(function (ele, index) {\n          var _a, _b, _c;\n\n          var dx = ele.x - ((_a = preNodes[index]) === null || _a === void 0 ? void 0 : _a.x);\n          var dy = ele.y - ((_b = preNodes[index]) === null || _b === void 0 ? void 0 : _b.y);\n          (_c = groupNodes[index]) === null || _c === void 0 ? void 0 : _c.forEach(function (n) {\n            n.x += dx;\n            n.y += dy;\n          });\n        });\n        resolve();\n      };\n\n      var layoutMethod = new Layout[adjust](layoutCfg);\n      layoutMethod.layout({\n        nodes: layoutNodes\n      });\n    });\n  };\n\n  LayoutController.prototype.hasGPUVersion = function (layoutName) {\n    var length = GPULayoutNames.length;\n\n    for (var i = 0; i < length; i++) {\n      if (GPULayoutNames[i] === layoutName) return true;\n    }\n\n    return false;\n  };\n\n  LayoutController.prototype.destroy = function () {\n    this.destoryLayoutMethods();\n    var worker = this.worker;\n\n    if (worker) {\n      worker.terminate();\n      this.worker = null;\n    }\n\n    this.destroyed = true;\n    this.graph.set('layout', undefined);\n    this.layoutCfg = undefined;\n    this.layoutType = undefined;\n    this.layoutMethods = undefined;\n    this.graph = null;\n  };\n\n  return LayoutController;\n}(AbstractLayout);\n\nexport default LayoutController;\n\nfunction updateLayoutPosition(data, layoutData) {\n  var nodes = data.nodes;\n  var layoutNodes = layoutData.nodes;\n  var nodeLength = nodes.length;\n\n  for (var i = 0; i < nodeLength; i++) {\n    var node = nodes[i];\n    node.x = layoutNodes[i].x;\n    node.y = layoutNodes[i].y;\n  }\n}\n\nfunction filterObject(collection, callback) {\n  var result = {};\n\n  if (collection && _typeof(collection) === 'object') {\n    Object.keys(collection).forEach(function (key) {\n      if (collection.hasOwnProperty(key) && callback(collection[key])) {\n        result[key] = collection[key];\n      }\n    });\n    return result;\n  }\n\n  return collection;\n}\n\nfunction updateGPUWorkerLayoutPosition(data, layoutData) {\n  var nodes = data.nodes;\n  var vertexEdgeData = layoutData.vertexEdgeData;\n  var nodeLength = nodes.length;\n\n  for (var i = 0; i < nodeLength; i++) {\n    var node = nodes[i];\n    var x = vertexEdgeData[4 * i];\n    var y = vertexEdgeData[4 * i + 1];\n    node.x = x;\n    node.y = y;\n  }\n}\n\nfunction addLayoutOrder(data, order) {\n  var _a;\n\n  if (!((_a = data === null || data === void 0 ? void 0 : data.nodes) === null || _a === void 0 ? void 0 : _a.length)) {\n    return;\n  }\n\n  var nodes = data.nodes;\n  nodes.forEach(function (node) {\n    node.layoutOrder = order;\n  });\n}","map":{"version":3,"sources":["C:/Users/Home/Desktop/cs-2005/node_modules/@antv/g6-pc/es/graph/controller/layout.js"],"names":["_typeof","obj","Symbol","iterator","constructor","prototype","__awaiter","__extends","__generator","AbstractLayout","Layout","LayoutWorker","LAYOUT_MESSAGE","gpuDetector","mix","clone","mockRaf","cb","setTimeout","mockCaf","reqId","clearTimeout","helper","requestAnimationFrame","callback","fn","window","webkitRequestAnimationFrame","cancelAnimationFrame","requestId","webkitCancelAnimationFrame","GPULayoutNames","LayoutPipesAdjustNames","LayoutController","_super","graph","_this","call","layoutCfg","get","layoutType","getLayoutType","worker","workerData","initLayout","getWorker","Worker","console","warn","workerScriptURL","stopWorker","terminate","requestId2","execLayoutMethod","order","Promise","reslove","reject","type","onLayoutEnd","emit","isGPU","hasGPUVersion","isForce","onTick_1","onTick","tick","refreshPositions","comboTrees","enableTick","layoutMethod","e","onTick_2","layoutData","filterLayoutData","data","addLayoutOrder","init","execute","isCustomLayout","layoutMethods","push","updateLayoutMethod","updateCfg","layout","success","setDataFromGraph","_a","nodes","hiddenNodes","width","height","Object","assign","center","destoryLayoutMethods","initPositions","split","gpuEnabled","enableGPU","webgl","layoutEndFormatted","adjust","onAllLayoutEnd","label","refreshLayout","pipes","adjustPipesBox","sent","workerEnabled","layoutWithWorker","start","resolve","then","forEach","cfg","index","catch","error","currentTick","currentTickData","runWebworker","_loop_1","_i","_b","length","allData","edges","offScreenCanvas","document","createElement","gpuWorkerAbility","navigator","filteredLayoutCfg","filterObject","value","postMessage","RUN","offscreen","transferControlToOffscreen","GPURUN","canvas","onmessage","event","handleWorkerMessage","eventData","TICK","updateLayoutPosition","totalTicks","END","GPUEND","updateGPUWorkerLayoutPosition","ERROR","message","updateLayoutCfg","currentCfg","includes","nodeSize","d","Math","max","preventOverlap","getLayoutBBox","groupNodes","layoutNodes","preNodes","ele","_c","dx","x","dy","y","n","layoutName","i","destroy","destroyed","set","undefined","nodeLength","node","collection","result","keys","key","hasOwnProperty","vertexEdgeData","layoutOrder"],"mappings":"AAAA,SAASA,OAAT,CAAiBC,GAAjB,EAAsB;AAAE;;AAA2B,MAAI,OAAOC,MAAP,KAAkB,UAAlB,IAAgC,OAAOA,MAAM,CAACC,QAAd,KAA2B,QAA/D,EAAyE;AAAEH,IAAAA,OAAO,GAAG,SAASA,OAAT,CAAiBC,GAAjB,EAAsB;AAAE,aAAO,OAAOA,GAAd;AAAoB,KAAtD;AAAyD,GAApI,MAA0I;AAAED,IAAAA,OAAO,GAAG,SAASA,OAAT,CAAiBC,GAAjB,EAAsB;AAAE,aAAOA,GAAG,IAAI,OAAOC,MAAP,KAAkB,UAAzB,IAAuCD,GAAG,CAACG,WAAJ,KAAoBF,MAA3D,IAAqED,GAAG,KAAKC,MAAM,CAACG,SAApF,GAAgG,QAAhG,GAA2G,OAAOJ,GAAzH;AAA+H,KAAjK;AAAoK;;AAAC,SAAOD,OAAO,CAACC,GAAD,CAAd;AAAsB;;AAE1X,SAASK,SAAT,EAAoBC,SAApB,EAA+BC,WAA/B,QAAkD,OAAlD;AACA,SAASC,cAAT,QAA+B,eAA/B;AACA,SAASC,MAAT,QAAuB,cAAvB;AACA,SAASC,YAAT,QAA6B,mCAA7B;AACA,SAASC,cAAT,QAA+B,iCAA/B;AACA,SAASC,WAAT,QAA4B,gBAA5B;AACA,SAASC,GAAT,EAAcC,KAAd,QAA2B,YAA3B,C,CAAyC;;AAEzC,IAAIC,OAAO,GAAG,SAASA,OAAT,CAAiBC,EAAjB,EAAqB;AACjC,SAAOC,UAAU,CAACD,EAAD,EAAK,EAAL,CAAjB;AACD,CAFD;;AAIA,IAAIE,OAAO,GAAG,SAASA,OAAT,CAAiBC,KAAjB,EAAwB;AACpC,SAAOC,YAAY,CAACD,KAAD,CAAnB;AACD,CAFD;;AAIA,IAAIE,MAAM,GAAG;AACX;AACAC,EAAAA,qBAAqB,EAAE,SAASA,qBAAT,CAA+BC,QAA/B,EAAyC;AAC9D,QAAIC,EAAE,GAAG,OAAOC,MAAP,KAAkB,WAAlB,GAAgCA,MAAM,CAACH,qBAAP,IAAgCG,MAAM,CAACC,2BAAvC,IAAsEX,OAAtG,GAAgHA,OAAzH;AACA,WAAOS,EAAE,CAACD,QAAD,CAAT;AACD,GALU;AAMXI,EAAAA,oBAAoB,EAAE,SAASA,oBAAT,CAA8BC,SAA9B,EAAyC;AAC7D,QAAIJ,EAAE,GAAG,OAAOC,MAAP,KAAkB,WAAlB,GAAgCA,MAAM,CAACE,oBAAP,IAA+BF,MAAM,CAACI,0BAAtC,IAAoEX,OAApG,GAA8GA,OAAvH;AACA,WAAOM,EAAE,CAACI,SAAD,CAAT;AACD;AATU,CAAb;AAWA,IAAIE,cAAc,GAAG,CAAC,aAAD,EAAgB,QAAhB,CAArB;AACA,IAAIC,sBAAsB,GAAG,CAAC,OAAD,EAAU,MAAV,EAAkB,UAAlB,CAA7B;;AAEA,IAAIC,gBAAgB;AACpB;AACA,UAAUC,MAAV,EAAkB;AAChB3B,EAAAA,SAAS,CAAC0B,gBAAD,EAAmBC,MAAnB,CAAT,CADgB,CACqB;AACrC;AACA;AACA;AACA;AACA;;;AAGA,WAASD,gBAAT,CAA0BE,KAA1B,EAAiC;AAC/B,QAAIC,KAAK,GAAGF,MAAM,CAACG,IAAP,CAAY,IAAZ,EAAkBF,KAAlB,KAA4B,IAAxC;;AAEAC,IAAAA,KAAK,CAACD,KAAN,GAAcA,KAAd;AACAC,IAAAA,KAAK,CAACE,SAAN,GAAkBH,KAAK,CAACI,GAAN,CAAU,QAAV,KAAuB,EAAzC;AACAH,IAAAA,KAAK,CAACI,UAAN,GAAmBJ,KAAK,CAACK,aAAN,EAAnB;AACAL,IAAAA,KAAK,CAACM,MAAN,GAAe,IAAf;AACAN,IAAAA,KAAK,CAACO,UAAN,GAAmB,EAAnB;;AAEAP,IAAAA,KAAK,CAACQ,UAAN;;AAEA,WAAOR,KAAP;AACD,GArBe,CAqBd;;;AAGFH,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2BuC,UAA3B,GAAwC,YAAY,CAAC;AACpD,GADD,CAxBgB,CAyBb;;;AAGHX,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2BwC,SAA3B,GAAuC,YAAY;AACjD,QAAI,KAAKH,MAAT,EAAiB;AACf,aAAO,KAAKA,MAAZ;AACD;;AAED,QAAI,OAAOI,MAAP,KAAkB,WAAtB,EAAmC;AACjC;AACAC,MAAAA,OAAO,CAACC,IAAR,CAAa,iDAAb;AACA,WAAKN,MAAL,GAAc,IAAd;AACD,KAJD,MAIO;AACL,WAAKA,MAAL,GAAc/B,YAAY,CAAC,KAAK2B,SAAL,CAAeW,eAAhB,CAA1B;AACD;;AAED,WAAO,KAAKP,MAAZ;AACD,GAdD,CA5BgB,CA0Cb;;;AAGHT,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2B6C,UAA3B,GAAwC,YAAY;AAClD,QAAIP,UAAU,GAAG,KAAKA,UAAtB;;AAEA,QAAI,CAAC,KAAKD,MAAV,EAAkB;AAChB;AACD;;AAED,SAAKA,MAAL,CAAYS,SAAZ;AACA,SAAKT,MAAL,GAAc,IAAd,CARkD,CAQ9B;;AAEpB,QAAIC,UAAU,CAACd,SAAf,EAA0B;AACxBP,MAAAA,MAAM,CAACM,oBAAP,CAA4Be,UAAU,CAACd,SAAvC;AACAc,MAAAA,UAAU,CAACd,SAAX,GAAuB,IAAvB;AACD;;AAED,QAAIc,UAAU,CAACS,UAAf,EAA2B;AACzB9B,MAAAA,MAAM,CAACM,oBAAP,CAA4Be,UAAU,CAACS,UAAvC;AACAT,MAAAA,UAAU,CAACS,UAAX,GAAwB,IAAxB;AACD;AACF,GAnBD;;AAqBAnB,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2BgD,gBAA3B,GAA8C,UAAUf,SAAV,EAAqBgB,KAArB,EAA4B;AACxE,QAAIlB,KAAK,GAAG,IAAZ;;AAEA,WAAO,IAAImB,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AAC5C,UAAItB,KAAK,GAAGC,KAAK,CAACD,KAAlB;AACA,UAAIK,UAAU,GAAGF,SAAS,CAACoB,IAA3B,CAF4C,CAEX;;AAEjCpB,MAAAA,SAAS,CAACqB,WAAV,GAAwB,YAAY;AAClCxB,QAAAA,KAAK,CAACyB,IAAN,CAAW,gBAAX,EAA6B;AAC3BF,UAAAA,IAAI,EAAElB;AADqB,SAA7B;AAGAgB,QAAAA,OAAO;AACR,OALD,CAJ4C,CASzC;;;AAGH,UAAIhB,UAAU,IAAIJ,KAAK,CAACyB,KAAxB,EAA+B;AAC7B,YAAI,CAACzB,KAAK,CAAC0B,aAAN,CAAoBtB,UAApB,CAAL,EAAsC;AACpCO,UAAAA,OAAO,CAACC,IAAR,CAAa,UAAUR,UAAV,GAAuB,wEAApC;AACD,SAFD,MAEO;AACLA,UAAAA,UAAU,GAAGA,UAAU,GAAG,MAA1B;AACD;AACF;;AAED,UAAIuB,OAAO,GAAGvB,UAAU,KAAK,OAAf,IAA0BA,UAAU,KAAK,SAAzC,IAAsDA,UAAU,KAAK,QAAnF;;AAEA,UAAIuB,OAAJ,EAAa;AACX,YAAIC,QAAQ,GAAG1B,SAAS,CAAC2B,MAAzB;;AAEA,YAAIC,IAAI,GAAG,SAASA,IAAT,GAAgB;AACzB,cAAIF,QAAJ,EAAc;AACZA,YAAAA,QAAQ;AACT;;AAED7B,UAAAA,KAAK,CAACgC,gBAAN;AACD,SAND;;AAQA7B,QAAAA,SAAS,CAAC4B,IAAV,GAAiBA,IAAjB;AACD,OAZD,MAYO,IAAI5B,SAAS,CAACoB,IAAV,KAAmB,YAAvB,EAAqC;AAC1CpB,QAAAA,SAAS,CAAC8B,UAAV,GAAuBjC,KAAK,CAACI,GAAN,CAAU,YAAV,CAAvB;AACD;;AAED,UAAI8B,UAAU,GAAG,KAAjB;AACA,UAAIC,YAAJ;;AAEA,UAAI;AACFA,QAAAA,YAAY,GAAG,IAAI5D,MAAM,CAAC8B,UAAD,CAAV,CAAuBF,SAAvB,CAAf;AACD,OAFD,CAEE,OAAOiC,CAAP,EAAU;AACVxB,QAAAA,OAAO,CAACC,IAAR,CAAa,yBAAyBR,UAAzB,GAAsC,4CAAnD;AACAiB,QAAAA,MAAM;AACP,OA9C2C,CA8C1C;;;AAGFY,MAAAA,UAAU,GAAGC,YAAY,CAACD,UAA1B;;AAEA,UAAIA,UAAJ,EAAgB;AACd,YAAIG,QAAQ,GAAGlC,SAAS,CAAC2B,MAAzB;;AAEA,YAAIC,IAAI,GAAG,SAASA,IAAT,GAAgB;AACzB,cAAIM,QAAJ,EAAc;AACZA,YAAAA,QAAQ;AACT;;AAEDrC,UAAAA,KAAK,CAACgC,gBAAN;AACD,SAND;;AAQAG,QAAAA,YAAY,CAACJ,IAAb,GAAoBA,IAApB;AACD;;AAED,UAAIO,UAAU,GAAGrC,KAAK,CAACsC,gBAAN,CAAuBtC,KAAK,CAACuC,IAA7B,EAAmCrC,SAAnC,CAAjB;;AAEAsC,MAAAA,cAAc,CAACH,UAAD,EAAanB,KAAb,CAAd;AACAgB,MAAAA,YAAY,CAACO,IAAb,CAAkBJ,UAAlB,EApE4C,CAoEb;AAC/B;;AAEAtC,MAAAA,KAAK,CAACyB,IAAN,CAAW,iBAAX,EAA8B;AAC5BF,QAAAA,IAAI,EAAElB;AADsB,OAA9B;AAGA8B,MAAAA,YAAY,CAACQ,OAAb;AACA,UAAIR,YAAY,CAACS,cAAb,IAA+BzC,SAAS,CAACqB,WAA7C,EAA0DrB,SAAS,CAACqB,WAAV;;AAE1DvB,MAAAA,KAAK,CAAC4C,aAAN,CAAoBC,IAApB,CAAyBX,YAAzB;AACD,KA9EM,CAAP;AA+ED,GAlFD;;AAoFArC,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2B6E,kBAA3B,GAAgD,UAAUZ,YAAV,EAAwBhC,SAAxB,EAAmC;AACjF,QAAIF,KAAK,GAAG,IAAZ;;AAEA,WAAO,IAAImB,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AAC5C,UAAItB,KAAK,GAAGC,KAAK,CAACD,KAAlB;AACA,UAAIK,UAAU,GAAGF,SAAS,KAAK,IAAd,IAAsBA,SAAS,KAAK,KAAK,CAAzC,GAA6C,KAAK,CAAlD,GAAsDA,SAAS,CAACoB,IAAjF,CAF4C,CAE2C;;AAEvFpB,MAAAA,SAAS,CAACqB,WAAV,GAAwB,YAAY;AAClCxB,QAAAA,KAAK,CAACyB,IAAN,CAAW,gBAAX,EAA6B;AAC3BF,UAAAA,IAAI,EAAElB;AADqB,SAA7B;AAGAgB,QAAAA,OAAO;AACR,OALD;;AAOA,UAAIiB,UAAU,GAAGrC,KAAK,CAACsC,gBAAN,CAAuBtC,KAAK,CAACuC,IAA7B,EAAmCrC,SAAnC,CAAjB;;AAEAgC,MAAAA,YAAY,CAACO,IAAb,CAAkBJ,UAAlB;AACAH,MAAAA,YAAY,CAACa,SAAb,CAAuB7C,SAAvB;AACAH,MAAAA,KAAK,CAACyB,IAAN,CAAW,iBAAX,EAA8B;AAC5BF,QAAAA,IAAI,EAAElB;AADsB,OAA9B;AAGA8B,MAAAA,YAAY,CAACQ,OAAb;AACA,UAAIR,YAAY,CAACS,cAAb,IAA+BzC,SAAS,CAACqB,WAA7C,EAA0DrB,SAAS,CAACqB,WAAV;AAC3D,KApBM,CAAP;AAqBD,GAxBD;AAyBA;AACF;AACA;AACA;;;AAGE1B,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2B+E,MAA3B,GAAoC,UAAUC,OAAV,EAAmB;AACrD,QAAIjD,KAAK,GAAG,IAAZ;;AAEA,QAAID,KAAK,GAAG,KAAKA,KAAjB;AACA,SAAKwC,IAAL,GAAY,KAAKW,gBAAL,EAAZ;AACA,QAAIC,EAAE,GAAG,KAAKZ,IAAd;AAAA,QACIa,KAAK,GAAGD,EAAE,CAACC,KADf;AAAA,QAEIC,WAAW,GAAGF,EAAE,CAACE,WAFrB;;AAIA,QAAI,CAACD,KAAL,EAAY;AACV,aAAO,KAAP;AACD;;AAED,QAAIE,KAAK,GAAGvD,KAAK,CAACI,GAAN,CAAU,OAAV,CAAZ;AACA,QAAIoD,MAAM,GAAGxD,KAAK,CAACI,GAAN,CAAU,QAAV,CAAb;AACA,QAAID,SAAS,GAAG,EAAhB;AACAsD,IAAAA,MAAM,CAACC,MAAP,CAAcvD,SAAd,EAAyB;AACvBoD,MAAAA,KAAK,EAAEA,KADgB;AAEvBC,MAAAA,MAAM,EAAEA,MAFe;AAGvBG,MAAAA,MAAM,EAAE,CAACJ,KAAK,GAAG,CAAT,EAAYC,MAAM,GAAG,CAArB;AAHe,KAAzB,EAIG,KAAKrD,SAJR;AAKA,SAAKA,SAAL,GAAiBA,SAAjB;AACA,SAAKyD,oBAAL;AACA5D,IAAAA,KAAK,CAACyB,IAAN,CAAW,cAAX;AACA,SAAKoC,aAAL,CAAmB1D,SAAS,CAACwD,MAA7B,EAAqCN,KAArC,EAxBqD,CAwBR;;AAE7C,SAAKQ,aAAL,CAAmB1D,SAAS,CAACwD,MAA7B,EAAqCL,WAArC,EA1BqD,CA0BF;;AAEnD,QAAIjD,UAAU,GAAGF,SAAS,CAACoB,IAA3B;;AAEA,QAAIlB,UAAU,IAAIA,UAAU,CAACyD,KAAX,CAAiB,GAAjB,EAAsB,CAAtB,MAA6B,KAA/C,EAAsD;AACpDzD,MAAAA,UAAU,GAAGA,UAAU,CAACyD,KAAX,CAAiB,GAAjB,EAAsB,CAAtB,CAAb;AACA3D,MAAAA,SAAS,CAAC4D,UAAV,GAAuB,IAAvB;AACD,KAjCoD,CAiCnD;;;AAGF,QAAIC,SAAS,GAAG,KAAhB;;AAEA,QAAI7D,SAAS,CAAC4D,UAAd,EAA0B;AACxBC,MAAAA,SAAS,GAAG,IAAZ,CADwB,CACN;;AAElB,UAAI,CAACtF,WAAW,GAAGuF,KAAnB,EAA0B;AACxBrD,QAAAA,OAAO,CAACC,IAAR,CAAa,2EAAb;AACAmD,QAAAA,SAAS,GAAG,KAAZ;AACD;AACF;;AAED,SAAKtC,KAAL,GAAasC,SAAb,CA/CqD,CA+C7B;;AAExB,QAAIxC,WAAW,GAAGrB,SAAS,CAACqB,WAA5B;AAAA,QACI0C,kBAAkB,GAAG/D,SAAS,CAAC+D,kBADnC;AAAA,QAEIC,MAAM,GAAGhE,SAAS,CAACgE,MAFvB;;AAIA,QAAI,CAACD,kBAAL,EAAyB;AACvB/D,MAAAA,SAAS,CAAC+D,kBAAV,GAA+B,IAA/B;;AAEA/D,MAAAA,SAAS,CAACiE,cAAV,GAA2B,YAAY;AACrC,eAAOjG,SAAS,CAAC8B,KAAD,EAAQ,KAAK,CAAb,EAAgB,KAAK,CAArB,EAAwB,YAAY;AAClD,iBAAO5B,WAAW,CAAC,IAAD,EAAO,UAAU+E,EAAV,EAAc;AACrC,oBAAQA,EAAE,CAACiB,KAAX;AACE,mBAAK,CAAL;AACE;AACA,oBAAI7C,WAAJ,EAAiB;AACfA,kBAAAA,WAAW;AACZ,iBAJH,CAII;;;AAGF,qBAAK8C,aAAL;AACA,oBAAI,EAAEH,MAAM,IAAIhE,SAAS,CAACoE,KAAtB,CAAJ,EAAkC,OAAO,CAAC;AAC1C;AADyC,kBAEvC,CAFuC,CAAP;AAGlC,uBAAO,CAAC;AACR;AADO,kBAEL,KAAKC,cAAL,CAAoB,KAAKhC,IAAzB,EAA+B2B,MAA/B,CAFK,CAAP;;AAIF,mBAAK,CAAL;AACEf,gBAAAA,EAAE,CAACqB,IAAH;;AAEA,qBAAKH,aAAL;AACAlB,gBAAAA,EAAE,CAACiB,KAAH,GAAW,CAAX;;AAEF,mBAAK,CAAL;AACE;AACArE,gBAAAA,KAAK,CAACyB,IAAN,CAAW,aAAX;AACA,uBAAO,CAAC;AACR;AADO,iBAAP;AAzBJ;AA6BD,WA9BiB,CAAlB;AA+BD,SAhCe,CAAhB;AAiCD,OAlCD;AAmCD;;AAED,SAAKV,UAAL;;AAEA,QAAIZ,SAAS,CAACuE,aAAV,IAA2B,KAAKC,gBAAL,CAAsB,KAAKnC,IAA3B,CAA/B,EAAiE;AAC/D;AACA,aAAO,IAAP;AACD;;AAED,QAAIoC,KAAK,GAAGxD,OAAO,CAACyD,OAAR,EAAZ;;AAEA,QAAI1E,SAAS,CAACoB,IAAd,EAAoB;AAClBqD,MAAAA,KAAK,GAAGA,KAAK,CAACE,IAAN,CAAW,YAAY;AAC7B,eAAO7E,KAAK,CAACiB,gBAAN,CAAuBf,SAAvB,EAAkC,CAAlC,CAAP;AACD,OAFO,CAAR;AAGD,KAJD,MAIO,IAAIA,SAAS,CAACoE,KAAd,EAAqB;AAC1BpE,MAAAA,SAAS,CAACoE,KAAV,CAAgBQ,OAAhB,CAAwB,UAAUC,GAAV,EAAeC,KAAf,EAAsB;AAC5CL,QAAAA,KAAK,GAAGA,KAAK,CAACE,IAAN,CAAW,YAAY;AAC7B,iBAAO7E,KAAK,CAACiB,gBAAN,CAAuB8D,GAAvB,EAA4BC,KAA5B,CAAP;AACD,SAFO,CAAR;AAGD,OAJD;AAKD,KAhHoD,CAgHnD;;;AAGFL,IAAAA,KAAK,CAACE,IAAN,CAAW,YAAY;AACrB,UAAI3E,SAAS,CAACiE,cAAd,EAA8BjE,SAAS,CAACiE,cAAV,GADT,CACqC;AAC1D;;AAEA,UAAIlB,OAAJ,EAAaA,OAAO;AACrB,KALD,EAKGgC,KALH,CAKS,UAAUC,KAAV,EAAiB;AACxBvE,MAAAA,OAAO,CAACC,IAAR,CAAa,sBAAb,EAAqCsE,KAArC;AACD,KAPD;AAQA,WAAO,KAAP;AACD,GA5HD;AA6HA;AACF;AACA;AACA;AACA;;;AAGErF,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2ByG,gBAA3B,GAA8C,UAAUnC,IAAV,EAAgB;AAC5D,QAAIvC,KAAK,GAAG,IAAZ;;AAEA,QAAImD,EAAE,GAAG,IAAT;AAAA,QACIjD,SAAS,GAAGiD,EAAE,CAACjD,SADnB;AAAA,QAEIH,KAAK,GAAGoD,EAAE,CAACpD,KAFf;;AAIA,QAAIO,MAAM,GAAG,KAAKG,SAAL,EAAb,CAP4D,CAO7B;;AAE/B,QAAIF,UAAU,GAAG,KAAKA,UAAtB;;AAEA,QAAI,CAACD,MAAL,EAAa;AACX,aAAO,KAAP;AACD;;AAEDC,IAAAA,UAAU,CAACd,SAAX,GAAuB,IAAvB;AACAc,IAAAA,UAAU,CAACS,UAAX,GAAwB,IAAxB;AACAT,IAAAA,UAAU,CAAC4E,WAAX,GAAyB,IAAzB;AACA5E,IAAAA,UAAU,CAAC6E,eAAX,GAA6B,IAA7B;AACArF,IAAAA,KAAK,CAACyB,IAAN,CAAW,cAAX;AACA,QAAImD,KAAK,GAAGxD,OAAO,CAACyD,OAAR,EAAZ;;AAEA,QAAI1E,SAAS,CAACoB,IAAd,EAAoB;AAClBqD,MAAAA,KAAK,GAAGA,KAAK,CAACE,IAAN,CAAW,YAAY;AAC7B,eAAO7E,KAAK,CAACqF,YAAN,CAAmB/E,MAAnB,EAA2BiC,IAA3B,EAAiCrC,SAAjC,CAAP;AACD,OAFO,CAAR;AAGD,KAJD,MAIO,IAAIA,SAAS,CAACoE,KAAd,EAAqB;AAC1B,UAAIgB,OAAO,GAAG,SAASA,OAAT,CAAiBP,GAAjB,EAAsB;AAClCJ,QAAAA,KAAK,GAAGA,KAAK,CAACE,IAAN,CAAW,YAAY;AAC7B,iBAAO7E,KAAK,CAACqF,YAAN,CAAmB/E,MAAnB,EAA2BiC,IAA3B,EAAiCwC,GAAjC,CAAP;AACD,SAFO,CAAR;AAGD,OAJD;;AAMA,WAAK,IAAIQ,EAAE,GAAG,CAAT,EAAYC,EAAE,GAAGtF,SAAS,CAACoE,KAAhC,EAAuCiB,EAAE,GAAGC,EAAE,CAACC,MAA/C,EAAuDF,EAAE,EAAzD,EAA6D;AAC3D,YAAIR,GAAG,GAAGS,EAAE,CAACD,EAAD,CAAZ;;AAEAD,QAAAA,OAAO,CAACP,GAAD,CAAP;AACD;AACF,KAtC2D,CAsC1D;;;AAGFJ,IAAAA,KAAK,CAACE,IAAN,CAAW,YAAY;AACrB,UAAI3E,SAAS,CAACiE,cAAd,EAA8BjE,SAAS,CAACiE,cAAV;AAC/B,KAFD,EAEGc,KAFH,CAES,UAAUC,KAAV,EAAiB;AACxBvE,MAAAA,OAAO,CAACuE,KAAR,CAAc,eAAd,EAA+BA,KAA/B;AACD,KAJD;AAKA,WAAO,IAAP;AACD,GA/CD;;AAiDArF,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2BoH,YAA3B,GAA0C,UAAU/E,MAAV,EAAkBoF,OAAlB,EAA2BxF,SAA3B,EAAsC;AAC9E,QAAIF,KAAK,GAAG,IAAZ;;AAEA,QAAIyB,KAAK,GAAG,KAAKA,KAAjB;AACA,QAAIc,IAAI,GAAG,KAAKD,gBAAL,CAAsBoD,OAAtB,EAA+BxF,SAA/B,CAAX;AACA,QAAIkD,KAAK,GAAGb,IAAI,CAACa,KAAjB;AAAA,QACIuC,KAAK,GAAGpD,IAAI,CAACoD,KADjB;AAEA,QAAIC,eAAe,GAAGC,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAtB;AACA,QAAIC,gBAAgB,GAAGtE,KAAK,IAAI,OAAOnC,MAAP,KAAkB,WAA3B,IAA0C;AACjEA,IAAAA,MAAM,CAAC0G,SADgB,IACH,CAACA,SAAS,CAAC,KAAD,CADP,IACkB;AACzC,yBAAqB1G,MAFE,IAEQ,gCAAgCsG,eAF/D,CAR8E,CAUE;AAChF;AACA;AACA;;AAEA,QAAIK,iBAAiB,GAAGC,YAAY,CAAChG,SAAD,EAAY,UAAUiG,KAAV,EAAiB;AAC/D,aAAO,OAAOA,KAAP,KAAiB,UAAxB;AACD,KAFmC,CAApC;;AAIA,QAAI,CAACJ,gBAAL,EAAuB;AACrBzF,MAAAA,MAAM,CAAC8F,WAAP,CAAmB;AACjB9E,QAAAA,IAAI,EAAE9C,cAAc,CAAC6H,GADJ;AAEjBjD,QAAAA,KAAK,EAAEA,KAFU;AAGjBuC,QAAAA,KAAK,EAAEA,KAHU;AAIjBzF,QAAAA,SAAS,EAAE+F;AAJM,OAAnB;AAMD,KAPD,MAOO;AACL,UAAIK,SAAS,GAAGV,eAAe,CAACW,0BAAhB,EAAhB,CADK,CACyD;;AAE9DN,MAAAA,iBAAiB,CAAC3E,IAAlB,GAAyB2E,iBAAiB,CAAC3E,IAAlB,GAAyB,MAAlD;AACAhB,MAAAA,MAAM,CAAC8F,WAAP,CAAmB;AACjB9E,QAAAA,IAAI,EAAE9C,cAAc,CAACgI,MADJ;AAEjBpD,QAAAA,KAAK,EAAEA,KAFU;AAGjBuC,QAAAA,KAAK,EAAEA,KAHU;AAIjBzF,QAAAA,SAAS,EAAE+F,iBAJM;AAKjBQ,QAAAA,MAAM,EAAEH;AALS,OAAnB,EAMG,CAACA,SAAD,CANH;AAOD;;AAED,WAAO,IAAInF,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AAC5Cf,MAAAA,MAAM,CAACoG,SAAP,GAAmB,UAAUC,KAAV,EAAiB;AAClC3G,QAAAA,KAAK,CAAC4G,mBAAN,CAA0BxF,OAA1B,EAAmCC,MAAnC,EAA2CsF,KAA3C,EAAkDpE,IAAlD,EAAwDrC,SAAxD;AACD,OAFD;AAGD,KAJM,CAAP;AAKD,GA5CD,CA1WgB,CAsZb;;;AAGHL,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2B2I,mBAA3B,GAAiD,UAAUxF,OAAV,EAAmBC,MAAnB,EAA2BsF,KAA3B,EAAkCpE,IAAlC,EAAwCrC,SAAxC,EAAmD;AAClG,QAAIiD,EAAE,GAAG,IAAT;AAAA,QACIpD,KAAK,GAAGoD,EAAE,CAACpD,KADf;AAAA,QAEIQ,UAAU,GAAG4C,EAAE,CAAC5C,UAFpB;;AAIA,QAAIsG,SAAS,GAAGF,KAAK,CAACpE,IAAtB;AACA,QAAIjB,IAAI,GAAGuF,SAAS,CAACvF,IAArB;;AAEA,QAAIO,MAAM,GAAG,SAASA,MAAT,GAAkB;AAC7B,UAAI3B,SAAS,CAAC2B,MAAd,EAAsB;AACpB3B,QAAAA,SAAS,CAAC2B,MAAV;AACD;AACF,KAJD;;AAMA,YAAQP,IAAR;AACE,WAAK9C,cAAc,CAACsI,IAApB;AACEvG,QAAAA,UAAU,CAAC4E,WAAX,GAAyB0B,SAAS,CAAC1B,WAAnC;AACA5E,QAAAA,UAAU,CAAC6E,eAAX,GAA6ByB,SAA7B;;AAEA,YAAI,CAACtG,UAAU,CAACd,SAAhB,EAA2B;AACzBc,UAAAA,UAAU,CAACd,SAAX,GAAuBP,MAAM,CAACC,qBAAP,CAA6B,SAASM,SAAT,GAAqB;AACvEsH,YAAAA,oBAAoB,CAACxE,IAAD,EAAOsE,SAAP,CAApB;AACA9G,YAAAA,KAAK,CAACgC,gBAAN;AACAF,YAAAA,MAAM;;AAEN,gBAAIgF,SAAS,CAAC1B,WAAV,KAA0B0B,SAAS,CAACG,UAAxC,EAAoD;AAClD;AACA5F,cAAAA,OAAO;AACR,aAHD,MAGO,IAAIb,UAAU,CAAC4E,WAAX,KAA2B0B,SAAS,CAACG,UAAzC,EAAqD;AAC1D;AACA;AACA;AACAzG,cAAAA,UAAU,CAACS,UAAX,GAAwB9B,MAAM,CAACC,qBAAP,CAA6B,SAAS6B,UAAT,GAAsB;AACzE+F,gBAAAA,oBAAoB,CAACxE,IAAD,EAAOhC,UAAU,CAAC6E,eAAlB,CAApB;AACArF,gBAAAA,KAAK,CAACgC,gBAAN;AACAxB,gBAAAA,UAAU,CAACS,UAAX,GAAwB,IAAxB;AACAa,gBAAAA,MAAM;AACNT,gBAAAA,OAAO;AACR,eANuB,CAAxB;AAOD;;AAEDb,YAAAA,UAAU,CAACd,SAAX,GAAuB,IAAvB;AACD,WAtBsB,CAAvB;AAuBD;;AAED;;AAEF,WAAKjB,cAAc,CAACyI,GAApB;AACE;AACA,YAAI1G,UAAU,CAAC4E,WAAX,IAA0B,IAA9B,EAAoC;AAClC4B,UAAAA,oBAAoB,CAACxE,IAAD,EAAOsE,SAAP,CAApB;AACAzF,UAAAA,OAAO;AACR;;AAED;;AAEF,WAAK5C,cAAc,CAAC0I,MAApB;AACE;AACA,YAAI3G,UAAU,CAAC4E,WAAX,IAA0B,IAA9B,EAAoC;AAClCgC,UAAAA,6BAA6B,CAAC5E,IAAD,EAAOsE,SAAP,CAA7B;AACAzF,UAAAA,OAAO;AACR;;AAED;;AAEF,WAAK5C,cAAc,CAAC4I,KAApB;AACEzG,QAAAA,OAAO,CAACC,IAAR,CAAa,0BAAb,EAAyCiG,SAAS,CAACQ,OAAnD;AACAhG,QAAAA,MAAM;AACN;;AAEF;AACEA,QAAAA,MAAM;AACN;AA1DJ;AA4DD,GA1ED,CAzZgB,CAmeb;;;AAGHxB,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2BqJ,eAA3B,GAA6C,UAAUvC,GAAV,EAAe;AAC1D,QAAI/E,KAAK,GAAG,IAAZ;;AAEA,QAAImD,EAAE,GAAG,IAAT;AAAA,QACIpD,KAAK,GAAGoD,EAAE,CAACpD,KADf;AAAA,QAEI6C,aAAa,GAAGO,EAAE,CAACP,aAFvB;;AAIA,QAAI1C,SAAS,GAAGxB,GAAG,CAAC,EAAD,EAAK,KAAKwB,SAAV,EAAqB6E,GAArB,CAAnB;AACA,SAAK7E,SAAL,GAAiBA,SAAjB;;AAEA,QAAI,EAAE0C,aAAa,KAAK,IAAlB,IAA0BA,aAAa,KAAK,KAAK,CAAjD,GAAqD,KAAK,CAA1D,GAA8DA,aAAa,CAAC6C,MAA9E,CAAJ,EAA2F;AACzF,WAAKzC,MAAL;AACA;AACD;;AAED,SAAKT,IAAL,GAAY,KAAKW,gBAAL,EAAZ;AACA,SAAKpC,UAAL;;AAEA,QAAIiE,GAAG,CAACN,aAAJ,IAAqB,KAAKC,gBAAL,CAAsB,KAAKnC,IAA3B,CAAzB,EAA2D;AACzD;AACA;AACD;;AAEDxC,IAAAA,KAAK,CAACyB,IAAN,CAAW,cAAX;AACA,QAAImD,KAAK,GAAGxD,OAAO,CAACyD,OAAR,EAAZ;;AAEA,QAAIhC,aAAa,CAAC6C,MAAd,KAAyB,CAA7B,EAAgC;AAC9Bd,MAAAA,KAAK,GAAGA,KAAK,CAACE,IAAN,CAAW,YAAY;AAC7B,eAAO7E,KAAK,CAAC8C,kBAAN,CAAyBF,aAAa,CAAC,CAAD,CAAtC,EAA2C1C,SAA3C,CAAP;AACD,OAFO,CAAR;AAGD,KAJD,MAIO;AACL0C,MAAAA,aAAa,KAAK,IAAlB,IAA0BA,aAAa,KAAK,KAAK,CAAjD,GAAqD,KAAK,CAA1D,GAA8DA,aAAa,CAACkC,OAAd,CAAsB,UAAU5C,YAAV,EAAwB8C,KAAxB,EAA+B;AACjH,YAAIuC,UAAU,GAAGrH,SAAS,CAACoE,KAAV,CAAgBU,KAAhB,CAAjB;AACAL,QAAAA,KAAK,GAAGA,KAAK,CAACE,IAAN,CAAW,YAAY;AAC7B,iBAAO7E,KAAK,CAAC8C,kBAAN,CAAyBZ,YAAzB,EAAuCqF,UAAvC,CAAP;AACD,SAFO,CAAR;AAGD,OAL6D,CAA9D;AAMD;;AAED5C,IAAAA,KAAK,CAACE,IAAN,CAAW,YAAY;AACrB,UAAI3E,SAAS,CAACiE,cAAd,EAA8BjE,SAAS,CAACiE,cAAV;AAC/B,KAFD,EAEGc,KAFH,CAES,UAAUC,KAAV,EAAiB;AACxBvE,MAAAA,OAAO,CAACC,IAAR,CAAa,eAAb,EAA8BsE,KAA9B;AACD,KAJD;AAKD,GA5CD;;AA8CArF,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2BsG,cAA3B,GAA4C,UAAUhC,IAAV,EAAgB2B,MAAhB,EAAwB;AAClE,QAAIlE,KAAK,GAAG,IAAZ;;AAEA,WAAO,IAAImB,OAAJ,CAAY,UAAUyD,OAAV,EAAmB;AACpC,UAAIxB,KAAK,GAAGb,IAAI,CAACa,KAAjB;;AAEA,UAAI,EAAEA,KAAK,KAAK,IAAV,IAAkBA,KAAK,KAAK,KAAK,CAAjC,GAAqC,KAAK,CAA1C,GAA8CA,KAAK,CAACqC,MAAtD,CAAJ,EAAmE;AACjEb,QAAAA,OAAO;AACR;;AAED,UAAI,CAAChF,sBAAsB,CAAC4H,QAAvB,CAAgCtD,MAAhC,CAAL,EAA8C;AAC5CvD,QAAAA,OAAO,CAACC,IAAR,CAAa,qBAAqBsD,MAArB,GAA8B,8EAA3C;AACAU,QAAAA,OAAO;AACR;;AAED,UAAI1E,SAAS,GAAG;AACdwD,QAAAA,MAAM,EAAE1D,KAAK,CAACE,SAAN,CAAgBwD,MADV;AAEd+D,QAAAA,QAAQ,EAAE,SAASA,QAAT,CAAkBC,CAAlB,EAAqB;AAC7B,iBAAOC,IAAI,CAACC,GAAL,CAASF,CAAC,CAACnE,MAAX,EAAmBmE,CAAC,CAACpE,KAArB,CAAP;AACD,SAJa;AAKduE,QAAAA,cAAc,EAAE,IALF;AAMdtG,QAAAA,WAAW,EAAE,SAASA,WAAT,GAAuB,CAAE;AANxB,OAAhB,CAZoC,CAmBjC;;AAEH,UAAI4B,EAAE,GAAGnD,KAAK,CAAC8H,aAAN,CAAoB1E,KAApB,CAAT;AAAA,UACI2E,UAAU,GAAG5E,EAAE,CAAC4E,UADpB;AAAA,UAEIC,WAAW,GAAG7E,EAAE,CAAC6E,WAFrB;;AAIA,UAAIC,QAAQ,GAAGtJ,KAAK,CAACqJ,WAAD,CAApB,CAzBoC,CAyBD;;AAEnC9H,MAAAA,SAAS,CAACqB,WAAV,GAAwB,YAAY;AAClCyG,QAAAA,WAAW,KAAK,IAAhB,IAAwBA,WAAW,KAAK,KAAK,CAA7C,GAAiD,KAAK,CAAtD,GAA0DA,WAAW,CAAClD,OAAZ,CAAoB,UAAUoD,GAAV,EAAelD,KAAf,EAAsB;AAClG,cAAI7B,EAAJ,EAAQqC,EAAR,EAAY2C,EAAZ;;AAEA,cAAIC,EAAE,GAAGF,GAAG,CAACG,CAAJ,IAAS,CAAClF,EAAE,GAAG8E,QAAQ,CAACjD,KAAD,CAAd,MAA2B,IAA3B,IAAmC7B,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAACkF,CAAxE,CAAT;AACA,cAAIC,EAAE,GAAGJ,GAAG,CAACK,CAAJ,IAAS,CAAC/C,EAAE,GAAGyC,QAAQ,CAACjD,KAAD,CAAd,MAA2B,IAA3B,IAAmCQ,EAAE,KAAK,KAAK,CAA/C,GAAmD,KAAK,CAAxD,GAA4DA,EAAE,CAAC+C,CAAxE,CAAT;AACA,WAACJ,EAAE,GAAGJ,UAAU,CAAC/C,KAAD,CAAhB,MAA6B,IAA7B,IAAqCmD,EAAE,KAAK,KAAK,CAAjD,GAAqD,KAAK,CAA1D,GAA8DA,EAAE,CAACrD,OAAH,CAAW,UAAU0D,CAAV,EAAa;AACpFA,YAAAA,CAAC,CAACH,CAAF,IAAOD,EAAP;AACAI,YAAAA,CAAC,CAACD,CAAF,IAAOD,EAAP;AACD,WAH6D,CAA9D;AAID,SATyD,CAA1D;AAUA1D,QAAAA,OAAO;AACR,OAZD;;AAcA,UAAI1C,YAAY,GAAG,IAAI5D,MAAM,CAAC4F,MAAD,CAAV,CAAmBhE,SAAnB,CAAnB;AACAgC,MAAAA,YAAY,CAACc,MAAb,CAAoB;AAClBI,QAAAA,KAAK,EAAE4E;AADW,OAApB;AAGD,KA7CM,CAAP;AA8CD,GAjDD;;AAmDAnI,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2ByD,aAA3B,GAA2C,UAAU+G,UAAV,EAAsB;AAC/D,QAAIhD,MAAM,GAAG9F,cAAc,CAAC8F,MAA5B;;AAEA,SAAK,IAAIiD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGjD,MAApB,EAA4BiD,CAAC,EAA7B,EAAiC;AAC/B,UAAI/I,cAAc,CAAC+I,CAAD,CAAd,KAAsBD,UAA1B,EAAsC,OAAO,IAAP;AACvC;;AAED,WAAO,KAAP;AACD,GARD;;AAUA5I,EAAAA,gBAAgB,CAAC5B,SAAjB,CAA2B0K,OAA3B,GAAqC,YAAY;AAC/C,SAAKhF,oBAAL;AACA,QAAIrD,MAAM,GAAG,KAAKA,MAAlB;;AAEA,QAAIA,MAAJ,EAAY;AACVA,MAAAA,MAAM,CAACS,SAAP;AACA,WAAKT,MAAL,GAAc,IAAd;AACD;;AAED,SAAKsI,SAAL,GAAiB,IAAjB;AACA,SAAK7I,KAAL,CAAW8I,GAAX,CAAe,QAAf,EAAyBC,SAAzB;AACA,SAAK5I,SAAL,GAAiB4I,SAAjB;AACA,SAAK1I,UAAL,GAAkB0I,SAAlB;AACA,SAAKlG,aAAL,GAAqBkG,SAArB;AACA,SAAK/I,KAAL,GAAa,IAAb;AACD,GAfD;;AAiBA,SAAOF,gBAAP;AACD,CAnmBD,CAmmBExB,cAnmBF,CAFA;;AAumBA,eAAewB,gBAAf;;AAEA,SAASkH,oBAAT,CAA8BxE,IAA9B,EAAoCF,UAApC,EAAgD;AAC9C,MAAIe,KAAK,GAAGb,IAAI,CAACa,KAAjB;AACA,MAAI4E,WAAW,GAAG3F,UAAU,CAACe,KAA7B;AACA,MAAI2F,UAAU,GAAG3F,KAAK,CAACqC,MAAvB;;AAEA,OAAK,IAAIiD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGK,UAApB,EAAgCL,CAAC,EAAjC,EAAqC;AACnC,QAAIM,IAAI,GAAG5F,KAAK,CAACsF,CAAD,CAAhB;AACAM,IAAAA,IAAI,CAACX,CAAL,GAASL,WAAW,CAACU,CAAD,CAAX,CAAeL,CAAxB;AACAW,IAAAA,IAAI,CAACT,CAAL,GAASP,WAAW,CAACU,CAAD,CAAX,CAAeH,CAAxB;AACD;AACF;;AAED,SAASrC,YAAT,CAAsB+C,UAAtB,EAAkC7J,QAAlC,EAA4C;AAC1C,MAAI8J,MAAM,GAAG,EAAb;;AAEA,MAAID,UAAU,IAAIrL,OAAO,CAACqL,UAAD,CAAP,KAAwB,QAA1C,EAAoD;AAClDzF,IAAAA,MAAM,CAAC2F,IAAP,CAAYF,UAAZ,EAAwBnE,OAAxB,CAAgC,UAAUsE,GAAV,EAAe;AAC7C,UAAIH,UAAU,CAACI,cAAX,CAA0BD,GAA1B,KAAkChK,QAAQ,CAAC6J,UAAU,CAACG,GAAD,CAAX,CAA9C,EAAiE;AAC/DF,QAAAA,MAAM,CAACE,GAAD,CAAN,GAAcH,UAAU,CAACG,GAAD,CAAxB;AACD;AACF,KAJD;AAKA,WAAOF,MAAP;AACD;;AAED,SAAOD,UAAP;AACD;;AAED,SAAS9B,6BAAT,CAAuC5E,IAAvC,EAA6CF,UAA7C,EAAyD;AACvD,MAAIe,KAAK,GAAGb,IAAI,CAACa,KAAjB;AACA,MAAIkG,cAAc,GAAGjH,UAAU,CAACiH,cAAhC;AACA,MAAIP,UAAU,GAAG3F,KAAK,CAACqC,MAAvB;;AAEA,OAAK,IAAIiD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGK,UAApB,EAAgCL,CAAC,EAAjC,EAAqC;AACnC,QAAIM,IAAI,GAAG5F,KAAK,CAACsF,CAAD,CAAhB;AACA,QAAIL,CAAC,GAAGiB,cAAc,CAAC,IAAIZ,CAAL,CAAtB;AACA,QAAIH,CAAC,GAAGe,cAAc,CAAC,IAAIZ,CAAJ,GAAQ,CAAT,CAAtB;AACAM,IAAAA,IAAI,CAACX,CAAL,GAASA,CAAT;AACAW,IAAAA,IAAI,CAACT,CAAL,GAASA,CAAT;AACD;AACF;;AAED,SAAS/F,cAAT,CAAwBD,IAAxB,EAA8BrB,KAA9B,EAAqC;AACnC,MAAIiC,EAAJ;;AAEA,MAAI,EAAE,CAACA,EAAE,GAAGZ,IAAI,KAAK,IAAT,IAAiBA,IAAI,KAAK,KAAK,CAA/B,GAAmC,KAAK,CAAxC,GAA4CA,IAAI,CAACa,KAAvD,MAAkE,IAAlE,IAA0ED,EAAE,KAAK,KAAK,CAAtF,GAA0F,KAAK,CAA/F,GAAmGA,EAAE,CAACsC,MAAxG,CAAJ,EAAqH;AACnH;AACD;;AAED,MAAIrC,KAAK,GAAGb,IAAI,CAACa,KAAjB;AACAA,EAAAA,KAAK,CAAC0B,OAAN,CAAc,UAAUkE,IAAV,EAAgB;AAC5BA,IAAAA,IAAI,CAACO,WAAL,GAAmBrI,KAAnB;AACD,GAFD;AAGD","sourcesContent":["function _typeof(obj) { \"@babel/helpers - typeof\"; if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\nimport { __awaiter, __extends, __generator } from \"tslib\";\nimport { AbstractLayout } from '@antv/g6-core';\nimport { Layout } from '../../layout';\nimport { LayoutWorker } from '../../layout/worker/layout.worker';\nimport { LAYOUT_MESSAGE } from '../../layout/worker/layoutConst';\nimport { gpuDetector } from '../../util/gpu';\nimport { mix, clone } from '@antv/util'; // eslint-disable-next-line @typescript-eslint/no-implied-eval\n\nvar mockRaf = function mockRaf(cb) {\n  return setTimeout(cb, 16);\n};\n\nvar mockCaf = function mockCaf(reqId) {\n  return clearTimeout(reqId);\n};\n\nvar helper = {\n  // pollyfill\n  requestAnimationFrame: function requestAnimationFrame(callback) {\n    var fn = typeof window !== 'undefined' ? window.requestAnimationFrame || window.webkitRequestAnimationFrame || mockRaf : mockRaf;\n    return fn(callback);\n  },\n  cancelAnimationFrame: function cancelAnimationFrame(requestId) {\n    var fn = typeof window !== 'undefined' ? window.cancelAnimationFrame || window.webkitCancelAnimationFrame || mockCaf : mockCaf;\n    return fn(requestId);\n  }\n};\nvar GPULayoutNames = ['fruchterman', 'gForce'];\nvar LayoutPipesAdjustNames = ['force', 'grid', 'circular'];\n\nvar LayoutController =\n/** @class */\nfunction (_super) {\n  __extends(LayoutController, _super); // the configurations of the layout\n  // private layoutCfg: any; // LayoutOptions\n  // the type name of the layout\n  // private layoutType: string;\n  // private data: GraphData;\n  // private layoutMethods: typeof Layout;\n\n\n  function LayoutController(graph) {\n    var _this = _super.call(this, graph) || this;\n\n    _this.graph = graph;\n    _this.layoutCfg = graph.get('layout') || {};\n    _this.layoutType = _this.getLayoutType();\n    _this.worker = null;\n    _this.workerData = {};\n\n    _this.initLayout();\n\n    return _this;\n  } // eslint-disable-next-line class-methods-use-this\n\n\n  LayoutController.prototype.initLayout = function () {// no data before rendering\n  }; // get layout worker and create one if not exists\n\n\n  LayoutController.prototype.getWorker = function () {\n    if (this.worker) {\n      return this.worker;\n    }\n\n    if (typeof Worker === 'undefined') {\n      // 如果当前浏览器不支持 web worker，则不使用 web worker\n      console.warn('Web worker is not supported in current browser.');\n      this.worker = null;\n    } else {\n      this.worker = LayoutWorker(this.layoutCfg.workerScriptURL);\n    }\n\n    return this.worker;\n  }; // stop layout worker\n\n\n  LayoutController.prototype.stopWorker = function () {\n    var workerData = this.workerData;\n\n    if (!this.worker) {\n      return;\n    }\n\n    this.worker.terminate();\n    this.worker = null; // 重新开始新的布局之前，先取消之前布局的requestAnimationFrame。\n\n    if (workerData.requestId) {\n      helper.cancelAnimationFrame(workerData.requestId);\n      workerData.requestId = null;\n    }\n\n    if (workerData.requestId2) {\n      helper.cancelAnimationFrame(workerData.requestId2);\n      workerData.requestId2 = null;\n    }\n  };\n\n  LayoutController.prototype.execLayoutMethod = function (layoutCfg, order) {\n    var _this = this;\n\n    return new Promise(function (reslove, reject) {\n      var graph = _this.graph;\n      var layoutType = layoutCfg.type; // 每个布局方法都需要注册\n\n      layoutCfg.onLayoutEnd = function () {\n        graph.emit('aftersublayout', {\n          type: layoutType\n        });\n        reslove();\n      }; // 若用户指定开启 gpu，且当前浏览器支持 webgl，且该算法存在 GPU 版本（目前仅支持 fruchterman 和 gForce），使用 gpu 版本的布局\n\n\n      if (layoutType && _this.isGPU) {\n        if (!_this.hasGPUVersion(layoutType)) {\n          console.warn(\"The '\" + layoutType + \"' layout does not support GPU calculation for now, it will run in CPU.\");\n        } else {\n          layoutType = layoutType + \"-gpu\";\n        }\n      }\n\n      var isForce = layoutType === 'force' || layoutType === 'g6force' || layoutType === 'gForce';\n\n      if (isForce) {\n        var onTick_1 = layoutCfg.onTick;\n\n        var tick = function tick() {\n          if (onTick_1) {\n            onTick_1();\n          }\n\n          graph.refreshPositions();\n        };\n\n        layoutCfg.tick = tick;\n      } else if (layoutCfg.type === 'comboForce') {\n        layoutCfg.comboTrees = graph.get('comboTrees');\n      }\n\n      var enableTick = false;\n      var layoutMethod;\n\n      try {\n        layoutMethod = new Layout[layoutType](layoutCfg);\n      } catch (e) {\n        console.warn(\"The layout method: '\" + layoutType + \"' does not exist! Please specify it first.\");\n        reject();\n      } // 是否需要迭代的方式完成布局。这里是来自布局对象的实例属性，是由布局的定义者在布局类定义的。\n\n\n      enableTick = layoutMethod.enableTick;\n\n      if (enableTick) {\n        var onTick_2 = layoutCfg.onTick;\n\n        var tick = function tick() {\n          if (onTick_2) {\n            onTick_2();\n          }\n\n          graph.refreshPositions();\n        };\n\n        layoutMethod.tick = tick;\n      }\n\n      var layoutData = _this.filterLayoutData(_this.data, layoutCfg);\n\n      addLayoutOrder(layoutData, order);\n      layoutMethod.init(layoutData); // 若存在节点没有位置信息，且没有设置 layout，在 initPositions 中 random 给出了所有节点的位置，不需要再次执行 random 布局\n      // 所有节点都有位置信息，且指定了 layout，则执行布局（代表不是第一次进行布局）\n\n      graph.emit('beforesublayout', {\n        type: layoutType\n      });\n      layoutMethod.execute();\n      if (layoutMethod.isCustomLayout && layoutCfg.onLayoutEnd) layoutCfg.onLayoutEnd();\n\n      _this.layoutMethods.push(layoutMethod);\n    });\n  };\n\n  LayoutController.prototype.updateLayoutMethod = function (layoutMethod, layoutCfg) {\n    var _this = this;\n\n    return new Promise(function (reslove, reject) {\n      var graph = _this.graph;\n      var layoutType = layoutCfg === null || layoutCfg === void 0 ? void 0 : layoutCfg.type; // 每个布局方法都需要注册\n\n      layoutCfg.onLayoutEnd = function () {\n        graph.emit('aftersublayout', {\n          type: layoutType\n        });\n        reslove();\n      };\n\n      var layoutData = _this.filterLayoutData(_this.data, layoutCfg);\n\n      layoutMethod.init(layoutData);\n      layoutMethod.updateCfg(layoutCfg);\n      graph.emit('beforesublayout', {\n        type: layoutType\n      });\n      layoutMethod.execute();\n      if (layoutMethod.isCustomLayout && layoutCfg.onLayoutEnd) layoutCfg.onLayoutEnd();\n    });\n  };\n  /**\n   * @param {function} success callback\n   * @return {boolean} 是否使用web worker布局\n   */\n\n\n  LayoutController.prototype.layout = function (success) {\n    var _this = this;\n\n    var graph = this.graph;\n    this.data = this.setDataFromGraph();\n    var _a = this.data,\n        nodes = _a.nodes,\n        hiddenNodes = _a.hiddenNodes;\n\n    if (!nodes) {\n      return false;\n    }\n\n    var width = graph.get('width');\n    var height = graph.get('height');\n    var layoutCfg = {};\n    Object.assign(layoutCfg, {\n      width: width,\n      height: height,\n      center: [width / 2, height / 2]\n    }, this.layoutCfg);\n    this.layoutCfg = layoutCfg;\n    this.destoryLayoutMethods();\n    graph.emit('beforelayout');\n    this.initPositions(layoutCfg.center, nodes); // init hidden ndoes\n\n    this.initPositions(layoutCfg.center, hiddenNodes); // 防止用户直接用 -gpu 结尾指定布局\n\n    var layoutType = layoutCfg.type;\n\n    if (layoutType && layoutType.split('-')[1] === 'gpu') {\n      layoutType = layoutType.split('-')[0];\n      layoutCfg.gpuEnabled = true;\n    } // 若用户指定开启 gpu，且当前浏览器支持 webgl，且该算法存在 GPU 版本（目前仅支持 fruchterman 和 gForce），使用 gpu 版本的布局\n\n\n    var enableGPU = false;\n\n    if (layoutCfg.gpuEnabled) {\n      enableGPU = true; // 打开下面语句将会导致 webworker 报找不到 window\n\n      if (!gpuDetector().webgl) {\n        console.warn(\"Your browser does not support webGL or GPGPU. The layout will run in CPU.\");\n        enableGPU = false;\n      }\n    }\n\n    this.isGPU = enableGPU; // 在 onAllLayoutEnd 中执行用户自定义 onLayoutEnd，触发 afterlayout、更新节点位置、fitView/fitCenter、触发 afterrender\n\n    var onLayoutEnd = layoutCfg.onLayoutEnd,\n        layoutEndFormatted = layoutCfg.layoutEndFormatted,\n        adjust = layoutCfg.adjust;\n\n    if (!layoutEndFormatted) {\n      layoutCfg.layoutEndFormatted = true;\n\n      layoutCfg.onAllLayoutEnd = function () {\n        return __awaiter(_this, void 0, void 0, function () {\n          return __generator(this, function (_a) {\n            switch (_a.label) {\n              case 0:\n                // 执行用户自定义 onLayoutEnd\n                if (onLayoutEnd) {\n                  onLayoutEnd();\n                } // 更新节点位置\n\n\n                this.refreshLayout();\n                if (!(adjust && layoutCfg.pipes)) return [3\n                /*break*/\n                , 2];\n                return [4\n                /*yield*/\n                , this.adjustPipesBox(this.data, adjust)];\n\n              case 1:\n                _a.sent();\n\n                this.refreshLayout();\n                _a.label = 2;\n\n              case 2:\n                // 触发 afterlayout\n                graph.emit('afterlayout');\n                return [2\n                /*return*/\n                ];\n            }\n          });\n        });\n      };\n    }\n\n    this.stopWorker();\n\n    if (layoutCfg.workerEnabled && this.layoutWithWorker(this.data)) {\n      // 如果启用布局web worker并且浏览器支持web worker，用web worker布局。否则回退到不用web worker布局。\n      return true;\n    }\n\n    var start = Promise.resolve();\n\n    if (layoutCfg.type) {\n      start = start.then(function () {\n        return _this.execLayoutMethod(layoutCfg, 0);\n      });\n    } else if (layoutCfg.pipes) {\n      layoutCfg.pipes.forEach(function (cfg, index) {\n        start = start.then(function () {\n          return _this.execLayoutMethod(cfg, index);\n        });\n      });\n    } // 最后统一在外部调用onAllLayoutEnd\n\n\n    start.then(function () {\n      if (layoutCfg.onAllLayoutEnd) layoutCfg.onAllLayoutEnd(); // 在执行 execute 后立即执行 success，且在 timeBar 中有 throttle，可以防止 timeBar 监听 afterrender 进行 changeData 后 layout，从而死循环\n      // 对于 force 一类布局完成后的 fitView 需要用户自己在 onLayoutEnd 中配置\n\n      if (success) success();\n    }).catch(function (error) {\n      console.warn('graph layout failed,', error);\n    });\n    return false;\n  };\n  /**\n   * layout with web worker\n   * @param {object} data graph data\n   * @return {boolean} 是否支持web worker\n   */\n\n\n  LayoutController.prototype.layoutWithWorker = function (data) {\n    var _this = this;\n\n    var _a = this,\n        layoutCfg = _a.layoutCfg,\n        graph = _a.graph;\n\n    var worker = this.getWorker(); // 每次worker message event handler调用之间的共享数据，会被修改。\n\n    var workerData = this.workerData;\n\n    if (!worker) {\n      return false;\n    }\n\n    workerData.requestId = null;\n    workerData.requestId2 = null;\n    workerData.currentTick = null;\n    workerData.currentTickData = null;\n    graph.emit('beforelayout');\n    var start = Promise.resolve();\n\n    if (layoutCfg.type) {\n      start = start.then(function () {\n        return _this.runWebworker(worker, data, layoutCfg);\n      });\n    } else if (layoutCfg.pipes) {\n      var _loop_1 = function _loop_1(cfg) {\n        start = start.then(function () {\n          return _this.runWebworker(worker, data, cfg);\n        });\n      };\n\n      for (var _i = 0, _b = layoutCfg.pipes; _i < _b.length; _i++) {\n        var cfg = _b[_i];\n\n        _loop_1(cfg);\n      }\n    } // 最后统一在外部调用onAllLayoutEnd\n\n\n    start.then(function () {\n      if (layoutCfg.onAllLayoutEnd) layoutCfg.onAllLayoutEnd();\n    }).catch(function (error) {\n      console.error('layout failed', error);\n    });\n    return true;\n  };\n\n  LayoutController.prototype.runWebworker = function (worker, allData, layoutCfg) {\n    var _this = this;\n\n    var isGPU = this.isGPU;\n    var data = this.filterLayoutData(allData, layoutCfg);\n    var nodes = data.nodes,\n        edges = data.edges;\n    var offScreenCanvas = document.createElement('canvas');\n    var gpuWorkerAbility = isGPU && typeof window !== 'undefined' && // eslint-disable-next-line @typescript-eslint/dot-notation\n    window.navigator && !navigator[\"gpu\"] && // WebGPU 还不支持 OffscreenCanvas\n    'OffscreenCanvas' in window && 'transferControlToOffscreen' in offScreenCanvas; // NOTE: postMessage的message参数里面不能包含函数，否则postMessage会报错，\n    // 例如：'function could not be cloned'。\n    // 详情参考：https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm\n    // 所以这里需要把过滤layoutCfg里的函数字段过滤掉。\n\n    var filteredLayoutCfg = filterObject(layoutCfg, function (value) {\n      return typeof value !== 'function';\n    });\n\n    if (!gpuWorkerAbility) {\n      worker.postMessage({\n        type: LAYOUT_MESSAGE.RUN,\n        nodes: nodes,\n        edges: edges,\n        layoutCfg: filteredLayoutCfg\n      });\n    } else {\n      var offscreen = offScreenCanvas.transferControlToOffscreen(); // filteredLayoutCfg.canvas = offscreen;\n\n      filteredLayoutCfg.type = filteredLayoutCfg.type + \"-gpu\";\n      worker.postMessage({\n        type: LAYOUT_MESSAGE.GPURUN,\n        nodes: nodes,\n        edges: edges,\n        layoutCfg: filteredLayoutCfg,\n        canvas: offscreen\n      }, [offscreen]);\n    }\n\n    return new Promise(function (reslove, reject) {\n      worker.onmessage = function (event) {\n        _this.handleWorkerMessage(reslove, reject, event, data, layoutCfg);\n      };\n    });\n  }; // success callback will be called when updating graph positions for the first time.\n\n\n  LayoutController.prototype.handleWorkerMessage = function (reslove, reject, event, data, layoutCfg) {\n    var _a = this,\n        graph = _a.graph,\n        workerData = _a.workerData;\n\n    var eventData = event.data;\n    var type = eventData.type;\n\n    var onTick = function onTick() {\n      if (layoutCfg.onTick) {\n        layoutCfg.onTick();\n      }\n    };\n\n    switch (type) {\n      case LAYOUT_MESSAGE.TICK:\n        workerData.currentTick = eventData.currentTick;\n        workerData.currentTickData = eventData;\n\n        if (!workerData.requestId) {\n          workerData.requestId = helper.requestAnimationFrame(function requestId() {\n            updateLayoutPosition(data, eventData);\n            graph.refreshPositions();\n            onTick();\n\n            if (eventData.currentTick === eventData.totalTicks) {\n              // 如果是最后一次tick\n              reslove();\n            } else if (workerData.currentTick === eventData.totalTicks) {\n              // 注意这里workerData.currentTick可能已经不再是前面赋值时候的值了，\n              // 因为在requestAnimationFrame等待时间里，可能产生新的tick。\n              // 如果当前tick不是最后一次tick，并且所有的tick消息都已发出来了，那么需要用最后一次tick的数据再刷新一次。\n              workerData.requestId2 = helper.requestAnimationFrame(function requestId2() {\n                updateLayoutPosition(data, workerData.currentTickData);\n                graph.refreshPositions();\n                workerData.requestId2 = null;\n                onTick();\n                reslove();\n              });\n            }\n\n            workerData.requestId = null;\n          });\n        }\n\n        break;\n\n      case LAYOUT_MESSAGE.END:\n        // 如果没有tick消息（非力导布局）\n        if (workerData.currentTick == null) {\n          updateLayoutPosition(data, eventData);\n          reslove();\n        }\n\n        break;\n\n      case LAYOUT_MESSAGE.GPUEND:\n        // 如果没有tick消息（非力导布局）\n        if (workerData.currentTick == null) {\n          updateGPUWorkerLayoutPosition(data, eventData);\n          reslove();\n        }\n\n        break;\n\n      case LAYOUT_MESSAGE.ERROR:\n        console.warn('Web-Worker layout error!', eventData.message);\n        reject();\n        break;\n\n      default:\n        reject();\n        break;\n    }\n  }; // 更新布局参数\n\n\n  LayoutController.prototype.updateLayoutCfg = function (cfg) {\n    var _this = this;\n\n    var _a = this,\n        graph = _a.graph,\n        layoutMethods = _a.layoutMethods;\n\n    var layoutCfg = mix({}, this.layoutCfg, cfg);\n    this.layoutCfg = layoutCfg;\n\n    if (!(layoutMethods === null || layoutMethods === void 0 ? void 0 : layoutMethods.length)) {\n      this.layout();\n      return;\n    }\n\n    this.data = this.setDataFromGraph();\n    this.stopWorker();\n\n    if (cfg.workerEnabled && this.layoutWithWorker(this.data)) {\n      // 如果启用布局web worker并且浏览器支持web worker，用web worker布局。否则回退到不用web worker布局。\n      return;\n    }\n\n    graph.emit('beforelayout');\n    var start = Promise.resolve();\n\n    if (layoutMethods.length === 1) {\n      start = start.then(function () {\n        return _this.updateLayoutMethod(layoutMethods[0], layoutCfg);\n      });\n    } else {\n      layoutMethods === null || layoutMethods === void 0 ? void 0 : layoutMethods.forEach(function (layoutMethod, index) {\n        var currentCfg = layoutCfg.pipes[index];\n        start = start.then(function () {\n          return _this.updateLayoutMethod(layoutMethod, currentCfg);\n        });\n      });\n    }\n\n    start.then(function () {\n      if (layoutCfg.onAllLayoutEnd) layoutCfg.onAllLayoutEnd();\n    }).catch(function (error) {\n      console.warn('layout failed', error);\n    });\n  };\n\n  LayoutController.prototype.adjustPipesBox = function (data, adjust) {\n    var _this = this;\n\n    return new Promise(function (resolve) {\n      var nodes = data.nodes;\n\n      if (!(nodes === null || nodes === void 0 ? void 0 : nodes.length)) {\n        resolve();\n      }\n\n      if (!LayoutPipesAdjustNames.includes(adjust)) {\n        console.warn(\"The adjust type \" + adjust + \" is not supported yet, please assign it with 'force', 'grid', or 'circular'.\");\n        resolve();\n      }\n\n      var layoutCfg = {\n        center: _this.layoutCfg.center,\n        nodeSize: function nodeSize(d) {\n          return Math.max(d.height, d.width);\n        },\n        preventOverlap: true,\n        onLayoutEnd: function onLayoutEnd() {}\n      }; // 计算出大单元\n\n      var _a = _this.getLayoutBBox(nodes),\n          groupNodes = _a.groupNodes,\n          layoutNodes = _a.layoutNodes;\n\n      var preNodes = clone(layoutNodes); // 根据大单元坐标的变化，调整这里面每个小单元nodes\n\n      layoutCfg.onLayoutEnd = function () {\n        layoutNodes === null || layoutNodes === void 0 ? void 0 : layoutNodes.forEach(function (ele, index) {\n          var _a, _b, _c;\n\n          var dx = ele.x - ((_a = preNodes[index]) === null || _a === void 0 ? void 0 : _a.x);\n          var dy = ele.y - ((_b = preNodes[index]) === null || _b === void 0 ? void 0 : _b.y);\n          (_c = groupNodes[index]) === null || _c === void 0 ? void 0 : _c.forEach(function (n) {\n            n.x += dx;\n            n.y += dy;\n          });\n        });\n        resolve();\n      };\n\n      var layoutMethod = new Layout[adjust](layoutCfg);\n      layoutMethod.layout({\n        nodes: layoutNodes\n      });\n    });\n  };\n\n  LayoutController.prototype.hasGPUVersion = function (layoutName) {\n    var length = GPULayoutNames.length;\n\n    for (var i = 0; i < length; i++) {\n      if (GPULayoutNames[i] === layoutName) return true;\n    }\n\n    return false;\n  };\n\n  LayoutController.prototype.destroy = function () {\n    this.destoryLayoutMethods();\n    var worker = this.worker;\n\n    if (worker) {\n      worker.terminate();\n      this.worker = null;\n    }\n\n    this.destroyed = true;\n    this.graph.set('layout', undefined);\n    this.layoutCfg = undefined;\n    this.layoutType = undefined;\n    this.layoutMethods = undefined;\n    this.graph = null;\n  };\n\n  return LayoutController;\n}(AbstractLayout);\n\nexport default LayoutController;\n\nfunction updateLayoutPosition(data, layoutData) {\n  var nodes = data.nodes;\n  var layoutNodes = layoutData.nodes;\n  var nodeLength = nodes.length;\n\n  for (var i = 0; i < nodeLength; i++) {\n    var node = nodes[i];\n    node.x = layoutNodes[i].x;\n    node.y = layoutNodes[i].y;\n  }\n}\n\nfunction filterObject(collection, callback) {\n  var result = {};\n\n  if (collection && _typeof(collection) === 'object') {\n    Object.keys(collection).forEach(function (key) {\n      if (collection.hasOwnProperty(key) && callback(collection[key])) {\n        result[key] = collection[key];\n      }\n    });\n    return result;\n  }\n\n  return collection;\n}\n\nfunction updateGPUWorkerLayoutPosition(data, layoutData) {\n  var nodes = data.nodes;\n  var vertexEdgeData = layoutData.vertexEdgeData;\n  var nodeLength = nodes.length;\n\n  for (var i = 0; i < nodeLength; i++) {\n    var node = nodes[i];\n    var x = vertexEdgeData[4 * i];\n    var y = vertexEdgeData[4 * i + 1];\n    node.x = x;\n    node.y = y;\n  }\n}\n\nfunction addLayoutOrder(data, order) {\n  var _a;\n\n  if (!((_a = data === null || data === void 0 ? void 0 : data.nodes) === null || _a === void 0 ? void 0 : _a.length)) {\n    return;\n  }\n\n  var nodes = data.nodes;\n  nodes.forEach(function (node) {\n    node.layoutOrder = order;\n  });\n}"]},"metadata":{},"sourceType":"module"}