{"ast":null,"code":"import _typeof from \"@babel/runtime/helpers/typeof\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nimport { gl } from '@antv/g-webgpu-core';\nimport { extractUniforms } from '../utils/uniform';\nimport { blendEquationMap, blendFuncMap, cullFaceMap, depthFuncMap, primitiveMap, stencilFuncMap, stencilOpMap } from './constants';\n/**\n * adaptor for regl.DrawCommand\n */\n\nvar ReglModel = /*#__PURE__*/function () {\n  function ReglModel(reGl, options) {\n    _classCallCheck(this, ReglModel);\n\n    this.reGl = void 0;\n    this.drawCommand = void 0;\n    this.uniforms = {};\n    this.reGl = reGl;\n    var vs = options.vs,\n        fs = options.fs,\n        defines = options.defines,\n        attributes = options.attributes,\n        uniforms = options.uniforms,\n        primitive = options.primitive,\n        count = options.count,\n        elements = options.elements,\n        depth = options.depth,\n        blend = options.blend,\n        stencil = options.stencil,\n        cull = options.cull,\n        instances = options.instances,\n        scissor = options.scissor,\n        viewport = options.viewport;\n    var reglUniforms = {};\n\n    if (uniforms) {\n      this.uniforms = extractUniforms(uniforms);\n      Object.keys(uniforms).forEach(function (uniformName) {\n        // use regl prop API\n        // @ts-ignore\n        reglUniforms[uniformName] = reGl.prop(uniformName);\n      });\n    }\n\n    var reglAttributes = {};\n    Object.keys(attributes).forEach(function (name) {\n      reglAttributes[name] = attributes[name].get();\n    });\n    var defineStmts = defines && this.generateDefines(defines) || '';\n    var drawParams = {\n      attributes: reglAttributes,\n      frag: \"#ifdef GL_FRAGMENT_PRECISION_HIGH\\n  precision highp float;\\n#else\\n  precision mediump float;\\n#endif\\n\".concat(defineStmts, \"\\n\").concat(fs),\n      uniforms: reglUniforms,\n      vert: \"\\n\".concat(defineStmts, \"\\n\").concat(vs),\n      primitive: primitiveMap[primitive === undefined ? gl.TRIANGLES : primitive]\n    };\n\n    if (instances) {\n      drawParams.instances = instances;\n    } // elements 中可能包含 count，此时不应传入\n\n\n    if (count) {\n      drawParams.count = count;\n    }\n\n    if (elements) {\n      drawParams.elements = elements.get();\n    }\n\n    if (scissor) {\n      drawParams.scissor = scissor;\n    }\n\n    if (viewport) {\n      drawParams.viewport = viewport;\n    }\n\n    this.initDepthDrawParams({\n      depth: depth\n    }, drawParams);\n    this.initBlendDrawParams({\n      blend: blend\n    }, drawParams);\n    this.initStencilDrawParams({\n      stencil: stencil\n    }, drawParams);\n    this.initCullDrawParams({\n      cull: cull\n    }, drawParams);\n    this.drawCommand = reGl(drawParams);\n  }\n\n  _createClass(ReglModel, [{\n    key: \"addUniforms\",\n    value: function addUniforms(uniforms) {\n      this.uniforms = _objectSpread(_objectSpread({}, this.uniforms), extractUniforms(uniforms));\n    }\n  }, {\n    key: \"draw\",\n    value: function draw(options) {\n      var uniforms = _objectSpread(_objectSpread({}, this.uniforms), extractUniforms(options.uniforms || {}));\n\n      var reglDrawProps = {};\n      Object.keys(uniforms).forEach(function (uniformName) {\n        var type = _typeof(uniforms[uniformName]);\n\n        if (type === 'boolean' || type === 'number' || Array.isArray(uniforms[uniformName]) || // @ts-ignore\n        uniforms[uniformName].BYTES_PER_ELEMENT) {\n          reglDrawProps[uniformName] = uniforms[uniformName];\n        } else if (type === 'string') {// TODO: image url\n        } else {\n          reglDrawProps[uniformName] = uniforms[uniformName].get();\n        }\n      });\n      this.drawCommand(reglDrawProps);\n    }\n  }, {\n    key: \"destroy\",\n    value: function destroy() {// don't need do anything since we will call `rendererService.cleanup()`\n    }\n    /**\n     * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#depth-buffer\n     */\n\n  }, {\n    key: \"initDepthDrawParams\",\n    value: function initDepthDrawParams(_ref, drawParams) {\n      var depth = _ref.depth;\n\n      if (depth) {\n        drawParams.depth = {\n          enable: depth.enable === undefined ? true : !!depth.enable,\n          mask: depth.mask === undefined ? true : !!depth.mask,\n          func: depthFuncMap[depth.func || gl.LESS],\n          range: depth.range || [0, 1]\n        };\n      }\n    }\n    /**\n     * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#blending\n     */\n\n  }, {\n    key: \"initBlendDrawParams\",\n    value: function initBlendDrawParams(_ref2, drawParams) {\n      var blend = _ref2.blend;\n\n      if (blend) {\n        var enable = blend.enable,\n            func = blend.func,\n            equation = blend.equation,\n            _blend$color = blend.color,\n            color = _blend$color === void 0 ? [0, 0, 0, 0] : _blend$color; // @ts-ignore\n\n        drawParams.blend = {\n          enable: !!enable,\n          func: {\n            srcRGB: blendFuncMap[func && func.srcRGB || gl.SRC_ALPHA],\n            srcAlpha: blendFuncMap[func && func.srcAlpha || gl.SRC_ALPHA],\n            dstRGB: blendFuncMap[func && func.dstRGB || gl.ONE_MINUS_SRC_ALPHA],\n            dstAlpha: blendFuncMap[func && func.dstAlpha || gl.ONE_MINUS_SRC_ALPHA]\n          },\n          equation: {\n            rgb: blendEquationMap[equation && equation.rgb || gl.FUNC_ADD],\n            alpha: blendEquationMap[equation && equation.alpha || gl.FUNC_ADD]\n          },\n          color: color\n        };\n      }\n    }\n    /**\n     * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#stencil\n     */\n\n  }, {\n    key: \"initStencilDrawParams\",\n    value: function initStencilDrawParams(_ref3, drawParams) {\n      var stencil = _ref3.stencil;\n\n      if (stencil) {\n        var enable = stencil.enable,\n            _stencil$mask = stencil.mask,\n            mask = _stencil$mask === void 0 ? -1 : _stencil$mask,\n            _stencil$func = stencil.func,\n            func = _stencil$func === void 0 ? {\n          cmp: gl.ALWAYS,\n          ref: 0,\n          mask: -1\n        } : _stencil$func,\n            _stencil$opFront = stencil.opFront,\n            opFront = _stencil$opFront === void 0 ? {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP\n        } : _stencil$opFront,\n            _stencil$opBack = stencil.opBack,\n            opBack = _stencil$opBack === void 0 ? {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP\n        } : _stencil$opBack;\n        drawParams.stencil = {\n          enable: !!enable,\n          mask: mask,\n          func: _objectSpread(_objectSpread({}, func), {}, {\n            cmp: stencilFuncMap[func.cmp]\n          }),\n          opFront: {\n            fail: stencilOpMap[opFront.fail],\n            zfail: stencilOpMap[opFront.zfail],\n            zpass: stencilOpMap[opFront.zpass]\n          },\n          opBack: {\n            fail: stencilOpMap[opBack.fail],\n            zfail: stencilOpMap[opBack.zfail],\n            zpass: stencilOpMap[opBack.zpass]\n          }\n        };\n      }\n    }\n    /**\n     * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#culling\n     */\n\n  }, {\n    key: \"initCullDrawParams\",\n    value: function initCullDrawParams(_ref4, drawParams) {\n      var cull = _ref4.cull;\n\n      if (cull) {\n        var enable = cull.enable,\n            _cull$face = cull.face,\n            face = _cull$face === void 0 ? gl.BACK : _cull$face;\n        drawParams.cull = {\n          enable: !!enable,\n          face: cullFaceMap[face]\n        };\n      }\n    }\n  }, {\n    key: \"generateDefines\",\n    value: function generateDefines(defines) {\n      return Object.keys(defines).map(function (name) {\n        return \"#define \".concat(name, \" \").concat(Number(defines[name]));\n      }).join('\\n');\n    }\n  }]);\n\n  return ReglModel;\n}();\n\nexport { ReglModel as default };","map":{"version":3,"sources":["../../src/webgl/ReglModel.ts"],"names":["ReglModel","reGl","drawCommand","uniforms","vs","fs","defines","attributes","primitive","count","elements","depth","blend","stencil","cull","instances","scissor","viewport","options","reglUniforms","extractUniforms","Object","reglAttributes","defineStmts","drawParams","frag","vert","primitiveMap","gl","reglDrawProps","type","Array","enable","mask","func","depthFuncMap","range","equation","color","srcRGB","blendFuncMap","srcAlpha","dstRGB","dstAlpha","rgb","blendEquationMap","alpha","cmp","ref","opFront","fail","zfail","zpass","KEEP","opBack","stencilFuncMap","stencilOpMap","face","cullFaceMap","Number"],"mappings":"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","sourcesContent":["import {\n  gl,\n  IModel,\n  IModelDrawOptions,\n  IModelInitializationOptions,\n  IUniform,\n} from '@antv/g-webgpu-core';\nimport regl from 'regl';\nimport { extractUniforms } from '../utils/uniform';\nimport {\n  blendEquationMap,\n  blendFuncMap,\n  cullFaceMap,\n  depthFuncMap,\n  primitiveMap,\n  stencilFuncMap,\n  stencilOpMap,\n} from './constants';\nimport ReglAttribute from './ReglAttribute';\nimport ReglElements from './ReglElements';\nimport ReglFramebuffer from './ReglFramebuffer';\nimport ReglTexture2D from './ReglTexture2D';\n\n/**\n * adaptor for regl.DrawCommand\n */\nexport default class ReglModel implements IModel {\n  private reGl: regl.Regl;\n  private drawCommand: regl.DrawCommand;\n  private uniforms: {\n    [key: string]: IUniform;\n  } = {};\n\n  constructor(reGl: regl.Regl, options: IModelInitializationOptions) {\n    this.reGl = reGl;\n    const {\n      vs,\n      fs,\n      defines,\n      attributes,\n      uniforms,\n      primitive,\n      count,\n      elements,\n      depth,\n      blend,\n      stencil,\n      cull,\n      instances,\n      scissor,\n      // @ts-ignore\n      viewport,\n    } = options;\n    const reglUniforms: { [key: string]: IUniform } = {};\n    if (uniforms) {\n      this.uniforms = extractUniforms(uniforms);\n      Object.keys(uniforms).forEach((uniformName) => {\n        // use regl prop API\n        // @ts-ignore\n        reglUniforms[uniformName] = reGl.prop(uniformName);\n      });\n    }\n\n    const reglAttributes: { [key: string]: regl.Attribute } = {};\n    Object.keys(attributes).forEach((name: string) => {\n      reglAttributes[name] = (attributes[name] as ReglAttribute).get();\n    });\n\n    const defineStmts = (defines && this.generateDefines(defines)) || '';\n    const drawParams: regl.DrawConfig = {\n      attributes: reglAttributes,\n      frag: `#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n${defineStmts}\n${fs}`,\n      uniforms: reglUniforms,\n      vert: `\n${defineStmts}\n${vs}`,\n      primitive:\n        primitiveMap[primitive === undefined ? gl.TRIANGLES : primitive],\n    };\n    if (instances) {\n      drawParams.instances = instances;\n    }\n\n    // elements 中可能包含 count，此时不应传入\n    if (count) {\n      drawParams.count = count;\n    }\n\n    if (elements) {\n      drawParams.elements = (elements as ReglElements).get();\n    }\n\n    if (scissor) {\n      drawParams.scissor = scissor;\n    }\n\n    if (viewport) {\n      drawParams.viewport = viewport;\n    }\n\n    this.initDepthDrawParams({ depth }, drawParams);\n    this.initBlendDrawParams({ blend }, drawParams);\n    this.initStencilDrawParams({ stencil }, drawParams);\n    this.initCullDrawParams({ cull }, drawParams);\n\n    this.drawCommand = reGl(drawParams);\n  }\n\n  public addUniforms(uniforms: { [key: string]: IUniform }) {\n    this.uniforms = {\n      ...this.uniforms,\n      ...extractUniforms(uniforms),\n    };\n  }\n\n  public draw(options: IModelDrawOptions) {\n    const uniforms: {\n      [key: string]: IUniform;\n    } = {\n      ...this.uniforms,\n      ...extractUniforms(options.uniforms || {}),\n    };\n\n    const reglDrawProps: {\n      [key: string]:\n        | regl.Framebuffer\n        | regl.Texture2D\n        | number\n        | number[]\n        | boolean;\n    } = {};\n\n    Object.keys(uniforms).forEach((uniformName: string) => {\n      const type = typeof uniforms[uniformName];\n      if (\n        type === 'boolean' ||\n        type === 'number' ||\n        Array.isArray(uniforms[uniformName]) ||\n        // @ts-ignore\n        uniforms[uniformName].BYTES_PER_ELEMENT\n      ) {\n        reglDrawProps[uniformName] = uniforms[uniformName] as\n          | number\n          | number[]\n          | boolean;\n      } else if (type === 'string') {\n        // TODO: image url\n      } else {\n        reglDrawProps[uniformName] = (uniforms[uniformName] as\n          | ReglFramebuffer\n          | ReglTexture2D).get();\n      }\n    });\n    this.drawCommand(reglDrawProps);\n  }\n\n  public destroy() {\n    // don't need do anything since we will call `rendererService.cleanup()`\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#depth-buffer\n   */\n  private initDepthDrawParams(\n    { depth }: Pick<IModelInitializationOptions, 'depth'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (depth) {\n      drawParams.depth = {\n        enable: depth.enable === undefined ? true : !!depth.enable,\n        mask: depth.mask === undefined ? true : !!depth.mask,\n        func: depthFuncMap[depth.func || gl.LESS],\n        range: depth.range || [0, 1],\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#blending\n   */\n  private initBlendDrawParams(\n    { blend }: Pick<IModelInitializationOptions, 'blend'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (blend) {\n      const { enable, func, equation, color = [0, 0, 0, 0] } = blend;\n      // @ts-ignore\n      drawParams.blend = {\n        enable: !!enable,\n        func: {\n          srcRGB: blendFuncMap[(func && func.srcRGB) || gl.SRC_ALPHA],\n          srcAlpha: blendFuncMap[(func && func.srcAlpha) || gl.SRC_ALPHA],\n          dstRGB: blendFuncMap[(func && func.dstRGB) || gl.ONE_MINUS_SRC_ALPHA],\n          dstAlpha:\n            blendFuncMap[(func && func.dstAlpha) || gl.ONE_MINUS_SRC_ALPHA],\n        },\n        equation: {\n          rgb: blendEquationMap[(equation && equation.rgb) || gl.FUNC_ADD],\n          alpha: blendEquationMap[(equation && equation.alpha) || gl.FUNC_ADD],\n        },\n        color,\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#stencil\n   */\n  private initStencilDrawParams(\n    { stencil }: Pick<IModelInitializationOptions, 'stencil'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (stencil) {\n      const {\n        enable,\n        mask = -1,\n        func = {\n          cmp: gl.ALWAYS,\n          ref: 0,\n          mask: -1,\n        },\n        opFront = {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP,\n        },\n        opBack = {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP,\n        },\n      } = stencil;\n      drawParams.stencil = {\n        enable: !!enable,\n        mask,\n        func: {\n          ...func,\n          cmp: stencilFuncMap[func.cmp],\n        },\n        opFront: {\n          fail: stencilOpMap[opFront.fail],\n          zfail: stencilOpMap[opFront.zfail],\n          zpass: stencilOpMap[opFront.zpass],\n        },\n        opBack: {\n          fail: stencilOpMap[opBack.fail],\n          zfail: stencilOpMap[opBack.zfail],\n          zpass: stencilOpMap[opBack.zpass],\n        },\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#culling\n   */\n  private initCullDrawParams(\n    { cull }: Pick<IModelInitializationOptions, 'cull'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (cull) {\n      const { enable, face = gl.BACK } = cull;\n      drawParams.cull = {\n        enable: !!enable,\n        face: cullFaceMap[face],\n      };\n    }\n  }\n\n  private generateDefines(defines: Record<string, number | boolean>) {\n    return Object.keys(defines)\n      .map((name) => `#define ${name} ${Number(defines[name])}`)\n      .join('\\n');\n  }\n}\n"]},"metadata":{},"sourceType":"module"}