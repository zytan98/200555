{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.resolve = void 0;\n\nvar ERROR_MSGS = require(\"../constants/error_msgs\");\n\nvar literal_types_1 = require(\"../constants/literal_types\");\n\nvar exceptions_1 = require(\"../utils/exceptions\");\n\nvar serialization_1 = require(\"../utils/serialization\");\n\nvar instantiation_1 = require(\"./instantiation\");\n\nvar invokeFactory = function (factoryType, serviceIdentifier, fn) {\n  try {\n    return fn();\n  } catch (error) {\n    if (exceptions_1.isStackOverflowExeption(error)) {\n      throw new Error(ERROR_MSGS.CIRCULAR_DEPENDENCY_IN_FACTORY(factoryType, serviceIdentifier.toString()));\n    } else {\n      throw error;\n    }\n  }\n};\n\nvar _resolveRequest = function (requestScope) {\n  return function (request) {\n    request.parentContext.setCurrentRequest(request);\n    var bindings = request.bindings;\n    var childRequests = request.childRequests;\n    var targetIsAnArray = request.target && request.target.isArray();\n    var targetParentIsNotAnArray = !request.parentRequest || !request.parentRequest.target || !request.target || !request.parentRequest.target.matchesArray(request.target.serviceIdentifier);\n\n    if (targetIsAnArray && targetParentIsNotAnArray) {\n      return childRequests.map(function (childRequest) {\n        var _f = _resolveRequest(requestScope);\n\n        return _f(childRequest);\n      });\n    } else {\n      var result = null;\n\n      if (request.target.isOptional() && bindings.length === 0) {\n        return undefined;\n      }\n\n      var binding_1 = bindings[0];\n      var isSingleton = binding_1.scope === literal_types_1.BindingScopeEnum.Singleton;\n      var isRequestSingleton = binding_1.scope === literal_types_1.BindingScopeEnum.Request;\n\n      if (isSingleton && binding_1.activated) {\n        return binding_1.cache;\n      }\n\n      if (isRequestSingleton && requestScope !== null && requestScope.has(binding_1.id)) {\n        return requestScope.get(binding_1.id);\n      }\n\n      if (binding_1.type === literal_types_1.BindingTypeEnum.ConstantValue) {\n        result = binding_1.cache;\n        binding_1.activated = true;\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Function) {\n        result = binding_1.cache;\n        binding_1.activated = true;\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Constructor) {\n        result = binding_1.implementationType;\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.DynamicValue && binding_1.dynamicValue !== null) {\n        result = invokeFactory(\"toDynamicValue\", binding_1.serviceIdentifier, function () {\n          return binding_1.dynamicValue(request.parentContext);\n        });\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Factory && binding_1.factory !== null) {\n        result = invokeFactory(\"toFactory\", binding_1.serviceIdentifier, function () {\n          return binding_1.factory(request.parentContext);\n        });\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Provider && binding_1.provider !== null) {\n        result = invokeFactory(\"toProvider\", binding_1.serviceIdentifier, function () {\n          return binding_1.provider(request.parentContext);\n        });\n      } else if (binding_1.type === literal_types_1.BindingTypeEnum.Instance && binding_1.implementationType !== null) {\n        result = instantiation_1.resolveInstance(binding_1.implementationType, childRequests, _resolveRequest(requestScope));\n      } else {\n        var serviceIdentifier = serialization_1.getServiceIdentifierAsString(request.serviceIdentifier);\n        throw new Error(ERROR_MSGS.INVALID_BINDING_TYPE + \" \" + serviceIdentifier);\n      }\n\n      if (typeof binding_1.onActivation === \"function\") {\n        result = binding_1.onActivation(request.parentContext, result);\n      }\n\n      if (isSingleton) {\n        binding_1.cache = result;\n        binding_1.activated = true;\n      }\n\n      if (isRequestSingleton && requestScope !== null && !requestScope.has(binding_1.id)) {\n        requestScope.set(binding_1.id, result);\n      }\n\n      return result;\n    }\n  };\n};\n\nfunction resolve(context) {\n  var _f = _resolveRequest(context.plan.rootRequest.requestScope);\n\n  return _f(context.plan.rootRequest);\n}\n\nexports.resolve = resolve;","map":{"version":3,"sources":["../../src/resolution/resolver.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.resolve = void 0;\nvar ERROR_MSGS = require(\"../constants/error_msgs\");\nvar literal_types_1 = require(\"../constants/literal_types\");\nvar exceptions_1 = require(\"../utils/exceptions\");\nvar serialization_1 = require(\"../utils/serialization\");\nvar instantiation_1 = require(\"./instantiation\");\nvar invokeFactory = function (factoryType, serviceIdentifier, fn) {\n    try {\n        return fn();\n    }\n    catch (error) {\n        if (exceptions_1.isStackOverflowExeption(error)) {\n            throw new Error(ERROR_MSGS.CIRCULAR_DEPENDENCY_IN_FACTORY(factoryType, serviceIdentifier.toString()));\n        }\n        else {\n            throw error;\n        }\n    }\n};\nvar _resolveRequest = function (requestScope) {\n    return function (request) {\n        request.parentContext.setCurrentRequest(request);\n        var bindings = request.bindings;\n        var childRequests = request.childRequests;\n        var targetIsAnArray = request.target && request.target.isArray();\n        var targetParentIsNotAnArray = !request.parentRequest ||\n            !request.parentRequest.target ||\n            !request.target ||\n            !request.parentRequest.target.matchesArray(request.target.serviceIdentifier);\n        if (targetIsAnArray && targetParentIsNotAnArray) {\n            return childRequests.map(function (childRequest) {\n                var _f = _resolveRequest(requestScope);\n                return _f(childRequest);\n            });\n        }\n        else {\n            var result = null;\n            if (request.target.isOptional() && bindings.length === 0) {\n                return undefined;\n            }\n            var binding_1 = bindings[0];\n            var isSingleton = binding_1.scope === literal_types_1.BindingScopeEnum.Singleton;\n            var isRequestSingleton = binding_1.scope === literal_types_1.BindingScopeEnum.Request;\n            if (isSingleton && binding_1.activated) {\n                return binding_1.cache;\n            }\n            if (isRequestSingleton &&\n                requestScope !== null &&\n                requestScope.has(binding_1.id)) {\n                return requestScope.get(binding_1.id);\n            }\n            if (binding_1.type === literal_types_1.BindingTypeEnum.ConstantValue) {\n                result = binding_1.cache;\n                binding_1.activated = true;\n            }\n            else if (binding_1.type === literal_types_1.BindingTypeEnum.Function) {\n                result = binding_1.cache;\n                binding_1.activated = true;\n            }\n            else if (binding_1.type === literal_types_1.BindingTypeEnum.Constructor) {\n                result = binding_1.implementationType;\n            }\n            else if (binding_1.type === literal_types_1.BindingTypeEnum.DynamicValue && binding_1.dynamicValue !== null) {\n                result = invokeFactory(\"toDynamicValue\", binding_1.serviceIdentifier, function () { return binding_1.dynamicValue(request.parentContext); });\n            }\n            else if (binding_1.type === literal_types_1.BindingTypeEnum.Factory && binding_1.factory !== null) {\n                result = invokeFactory(\"toFactory\", binding_1.serviceIdentifier, function () { return binding_1.factory(request.parentContext); });\n            }\n            else if (binding_1.type === literal_types_1.BindingTypeEnum.Provider && binding_1.provider !== null) {\n                result = invokeFactory(\"toProvider\", binding_1.serviceIdentifier, function () { return binding_1.provider(request.parentContext); });\n            }\n            else if (binding_1.type === literal_types_1.BindingTypeEnum.Instance && binding_1.implementationType !== null) {\n                result = instantiation_1.resolveInstance(binding_1.implementationType, childRequests, _resolveRequest(requestScope));\n            }\n            else {\n                var serviceIdentifier = serialization_1.getServiceIdentifierAsString(request.serviceIdentifier);\n                throw new Error(ERROR_MSGS.INVALID_BINDING_TYPE + \" \" + serviceIdentifier);\n            }\n            if (typeof binding_1.onActivation === \"function\") {\n                result = binding_1.onActivation(request.parentContext, result);\n            }\n            if (isSingleton) {\n                binding_1.cache = result;\n                binding_1.activated = true;\n            }\n            if (isRequestSingleton &&\n                requestScope !== null &&\n                !requestScope.has(binding_1.id)) {\n                requestScope.set(binding_1.id, result);\n            }\n            return result;\n        }\n    };\n};\nfunction resolve(context) {\n    var _f = _resolveRequest(context.plan.rootRequest.requestScope);\n    return _f(context.plan.rootRequest);\n}\nexports.resolve = resolve;\n//# sourceMappingURL=resolver.js.map"]},"metadata":{},"sourceType":"script"}