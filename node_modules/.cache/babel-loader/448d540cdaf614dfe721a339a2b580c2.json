{"ast":null,"code":"import { __assign, __rest } from \"tslib\";\nimport { isArray, get, deepMix, isEqual } from '@antv/util';\nimport { interaction, animation, theme, tooltip, scale } from '../../adaptor/common';\nimport { schema as schemaGeometry } from '../../adaptor/geometries';\nimport { deepAssign, flow, findGeometry, transformLabel, getAdjustAppendPadding, normalPadding, resolveAllPadding } from '../../utils';\nimport { log, LEVEL } from '../../utils';\nimport { getColorMap, layoutVennData, islegalSets } from './utils';\nimport { ID_FIELD } from './constant';\nimport './shape';\nimport './label';\nimport './interactions';\n/** 图例默认预留空间 */\n\nexport var LEGEND_SPACE = 40;\n/**\n * 获取 color 映射\n */\n\nfunction colorMap(params, data, colorPalette) {\n  var chart = params.chart,\n      options = params.options;\n  var blendMode = options.blendMode,\n      setsField = options.setsField;\n\n  var _a = chart.getTheme(),\n      colors10 = _a.colors10,\n      colors20 = _a.colors20;\n\n  var palette = colorPalette;\n\n  if (!isArray(palette)) {\n    palette = data.filter(function (d) {\n      return d[setsField].length === 1;\n    }).length <= 10 ? colors10 : colors20;\n  }\n\n  var map = getColorMap(palette, data, blendMode, setsField);\n  return function (id) {\n    return map.get(id) || palette[0];\n  };\n}\n/**\n * color options 转换\n */\n\n\nfunction transformColor(params, data) {\n  var options = params.options;\n  var color = options.color;\n\n  if (typeof color !== 'function') {\n    var colorPalette = typeof color === 'string' ? [color] : color;\n    var map_1 = colorMap(params, data, colorPalette);\n    return function (datum) {\n      return map_1(datum[ID_FIELD]);\n    };\n  }\n\n  return color;\n}\n/**\n * 处理 padding\n */\n\n\nfunction padding(params) {\n  var chart = params.chart,\n      options = params.options;\n  var legend = options.legend,\n      appendPadding = options.appendPadding,\n      padding = options.padding; // 处理 legend 的位置. 默认预留 40px, 业务上可以通过 appendPadding 增加\n\n  var tempPadding = normalPadding(appendPadding);\n\n  if (legend !== false) {\n    tempPadding = getAdjustAppendPadding(appendPadding, get(legend, 'position'), LEGEND_SPACE);\n  }\n\n  chart.appendPadding = resolveAllPadding([tempPadding, padding]);\n  return params;\n}\n/**\n * 处理非法数据\n * @param params\n */\n\n\nfunction data(params) {\n  var options = params.options;\n  /* 如遇到 交集 中存在 非法元素 的情况，就过滤掉\n   * 如：\n   * data = [\n   *   { sets: ['A'], size: 3 }, // 集合\n   *   { sets: ['B'], size: 4 }, // 集合\n   *   { sets: ['A', 'B'], size: 2 }, // 交集\n   *   { sets: ['A', 'B', 'C'], size: 2 }, // 交集 (存在非法 C，过滤该条数据)\n   *   ...\n   * ]\n   */\n\n  var data = options['data'];\n\n  if (!data) {\n    log(LEVEL.WARN, false, 'warn: %s', '数据不能为空');\n    data = [];\n  } // 合法元素的集合：['A', 'B']\n\n\n  var currSets = data.filter(function (datum) {\n    return datum.sets.length === 1;\n  }).map(function (datum) {\n    return datum.sets[0];\n  }); // 过滤 data\n\n  var filterSets = data.filter(function (datum) {\n    var sets = datum.sets; // 存在非法元素，就过滤这条数据\n\n    return islegalSets(currSets, sets);\n  });\n  if (!isEqual(filterSets, data)) log(LEVEL.WARN, false, 'warn: %s', '交集中不能出现不存在的集合, 请输入合法数据');\n  return deepMix({}, params, {\n    options: {\n      data: filterSets\n    }\n  });\n}\n/**\n * geometry 处理\n * @param params\n */\n\n\nfunction geometry(params) {\n  var chart = params.chart,\n      options = params.options;\n  var pointStyle = options.pointStyle,\n      setsField = options.setsField,\n      sizeField = options.sizeField; // 获取容器大小\n\n  var _a = normalPadding(chart.appendPadding),\n      t = _a[0],\n      r = _a[1],\n      b = _a[2],\n      l = _a[3]; // 处理 legend 的位置. 默认预留 40px, 业务上可以通过 appendPadding 增加\n\n\n  var customInfo = {\n    offsetX: l,\n    offsetY: t\n  }; // coordinateBBox + appendPadding = viewBBox, 不需要再计算 appendPadding 部分，因此直接使用 viewBBox\n\n  var _b = chart.viewBBox,\n      width = _b.width,\n      height = _b.height; // 处理padding输入不合理的情况， w 和 h 不能为负数\n\n  var vennData = layoutVennData(options, Math.max(width - (r + l), 0), Math.max(height - (t + b), 0), 0);\n  chart.data(vennData);\n  var ext = schemaGeometry(deepAssign({}, params, {\n    options: {\n      xField: 'x',\n      yField: 'y',\n      sizeField: sizeField,\n      seriesField: ID_FIELD,\n      rawFields: [setsField, sizeField],\n      schema: {\n        shape: 'venn',\n        style: pointStyle\n      }\n    }\n  })).ext;\n  var geometry = ext.geometry;\n  geometry.customInfo(customInfo);\n  var colorOptions = transformColor(params, vennData); // 韦恩图试点, color 通道只能映射一个字段. 通过外部查找获取 datum\n\n  if (typeof colorOptions === 'function') {\n    geometry.color(ID_FIELD, function (id) {\n      var datum = vennData.find(function (d) {\n        return d[ID_FIELD] === id;\n      });\n      var defaultColor = colorMap(params, vennData)(id);\n      return colorOptions(datum, defaultColor);\n    });\n  }\n\n  return params;\n}\n/**\n * 处理 label\n * @param params\n */\n\n\nfunction label(params) {\n  var chart = params.chart,\n      options = params.options;\n  var label = options.label; // 获取容器大小\n\n  var _a = normalPadding(chart.appendPadding),\n      t = _a[0],\n      l = _a[3]; // 传入 label 布局函数所需的 自定义参数\n\n\n  var customLabelInfo = {\n    offsetX: l,\n    offsetY: t\n  };\n  var geometry = findGeometry(chart, 'schema');\n\n  if (!label) {\n    geometry.label(false);\n  } else {\n    var callback = label.callback,\n        cfg = __rest(label, [\"callback\"]);\n\n    geometry.label({\n      fields: ['id'],\n      callback: callback,\n      cfg: deepMix({}, transformLabel(cfg), {\n        // 使用 G2 的 自定义label 修改位置\n        type: 'venn',\n        customLabelInfo: customLabelInfo\n      })\n    });\n  }\n\n  return params;\n}\n/**\n * legend 配置\n * @param params\n */\n\n\nexport function legend(params) {\n  var chart = params.chart,\n      options = params.options;\n  var legend = options.legend,\n      sizeField = options.sizeField;\n  chart.legend(ID_FIELD, legend); // 强制不开启 连续图例\n\n  chart.legend(sizeField, false);\n  return params;\n}\n/**\n * 默认关闭坐标轴\n * @param params\n */\n\nexport function axis(params) {\n  var chart = params.chart;\n  chart.axis(false);\n  return params;\n}\n/**\n * 韦恩图 interaction 交互适配器\n */\n\nfunction vennInteraction(params) {\n  var options = params.options,\n      chart = params.chart;\n  var interactions = options.interactions;\n\n  if (interactions) {\n    var MAP_1 = {\n      'legend-active': 'venn-legend-active',\n      'legend-highlight': 'venn-legend-highlight'\n    };\n    interaction(deepAssign({}, params, {\n      options: {\n        interactions: interactions.map(function (i) {\n          return __assign(__assign({}, i), {\n            type: MAP_1[i.type] || i.type\n          });\n        })\n      }\n    }));\n  }\n\n  chart.removeInteraction('legend-active');\n  chart.removeInteraction('legend-highlight');\n  return params;\n}\n/**\n * 图适配器\n * @param chart\n * @param options\n */\n\n\nexport function adaptor(params) {\n  // flow 的方式处理所有的配置到 G2 API\n  return flow(padding, theme, data, geometry, label, scale({}), legend, axis, tooltip, vennInteraction, animation // ... 其他的 adaptor flow\n  )(params);\n}","map":{"version":3,"sources":["../../../src/plots/venn/adaptor.ts"],"names":[],"mappings":"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","sourcesContent":["import { Geometry } from '@antv/g2';\nimport { isArray, get, deepMix, isEqual } from '@antv/util';\nimport { interaction, animation, theme, tooltip, scale } from '../../adaptor/common';\nimport { Params } from '../../core/adaptor';\nimport { schema as schemaGeometry } from '../../adaptor/geometries';\nimport {\n  deepAssign,\n  flow,\n  findGeometry,\n  transformLabel,\n  getAdjustAppendPadding,\n  normalPadding,\n  resolveAllPadding,\n} from '../../utils';\nimport { Datum } from '../../types';\nimport { log, LEVEL } from '../../utils';\nimport { getColorMap, layoutVennData, islegalSets } from './utils';\nimport { CustomInfo, VennData, VennOptions } from './types';\nimport { ID_FIELD } from './constant';\nimport './shape';\nimport './label';\nimport './interactions';\n\n/** 图例默认预留空间 */\nexport const LEGEND_SPACE = 40;\n\n/**\n * 获取 color 映射\n */\nfunction colorMap(params: Params<VennOptions>, data: VennData, colorPalette?: string[]) {\n  const { chart, options } = params;\n  const { blendMode, setsField } = options;\n  const { colors10, colors20 } = chart.getTheme();\n  let palette = colorPalette;\n  if (!isArray(palette)) {\n    palette = data.filter((d) => d[setsField].length === 1).length <= 10 ? colors10 : colors20;\n  }\n  const map = getColorMap(palette, data, blendMode, setsField);\n\n  return (id: string) => map.get(id) || palette[0];\n}\n\n/**\n * color options 转换\n */\nfunction transformColor(params: Params<VennOptions>, data: VennData): VennOptions['color'] {\n  const { options } = params;\n  const { color } = options;\n\n  if (typeof color !== 'function') {\n    const colorPalette = typeof color === 'string' ? [color] : color;\n    const map = colorMap(params, data, colorPalette);\n    return (datum: Datum) => map(datum[ID_FIELD]);\n  }\n  return color;\n}\n\n/**\n * 处理 padding\n */\nfunction padding(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart, options } = params;\n  const { legend, appendPadding, padding } = options;\n\n  // 处理 legend 的位置. 默认预留 40px, 业务上可以通过 appendPadding 增加\n  let tempPadding: number[] = normalPadding(appendPadding);\n  if (legend !== false) {\n    tempPadding = getAdjustAppendPadding(appendPadding, get(legend, 'position'), LEGEND_SPACE);\n  }\n\n  chart.appendPadding = resolveAllPadding([tempPadding, padding]);\n\n  return params;\n}\n\n/**\n * 处理非法数据\n * @param params\n */\nfunction data(params: Params<VennOptions>): Params<VennOptions> {\n  const { options } = params;\n\n  /* 如遇到 交集 中存在 非法元素 的情况，就过滤掉\n   * 如：\n   * data = [\n   *   { sets: ['A'], size: 3 }, // 集合\n   *   { sets: ['B'], size: 4 }, // 集合\n   *   { sets: ['A', 'B'], size: 2 }, // 交集\n   *   { sets: ['A', 'B', 'C'], size: 2 }, // 交集 (存在非法 C，过滤该条数据)\n   *   ...\n   * ]\n   */\n\n  let data = options['data'];\n  if (!data) {\n    log(LEVEL.WARN, false, 'warn: %s', '数据不能为空');\n    data = [];\n  }\n\n  // 合法元素的集合：['A', 'B']\n  const currSets = data.filter((datum) => datum.sets.length === 1).map((datum) => datum.sets[0]);\n  // 过滤 data\n  const filterSets = data.filter((datum) => {\n    const sets = datum.sets;\n    // 存在非法元素，就过滤这条数据\n    return islegalSets(currSets, sets);\n  });\n\n  if (!isEqual(filterSets, data)) log(LEVEL.WARN, false, 'warn: %s', '交集中不能出现不存在的集合, 请输入合法数据');\n\n  return deepMix({}, params, {\n    options: {\n      data: filterSets,\n    },\n  });\n}\n\n/**\n * geometry 处理\n * @param params\n */\nfunction geometry(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart, options } = params;\n  const { pointStyle, setsField, sizeField } = options;\n\n  // 获取容器大小\n  const [t, r, b, l] = normalPadding(chart.appendPadding);\n  // 处理 legend 的位置. 默认预留 40px, 业务上可以通过 appendPadding 增加\n  const customInfo: CustomInfo = { offsetX: l, offsetY: t };\n  // coordinateBBox + appendPadding = viewBBox, 不需要再计算 appendPadding 部分，因此直接使用 viewBBox\n  const { width, height } = chart.viewBBox;\n  // 处理padding输入不合理的情况， w 和 h 不能为负数\n  const vennData: VennData = layoutVennData(options, Math.max(width - (r + l), 0), Math.max(height - (t + b), 0), 0);\n  chart.data(vennData);\n\n  const { ext } = schemaGeometry(\n    deepAssign({}, params, {\n      options: {\n        xField: 'x',\n        yField: 'y',\n        sizeField: sizeField,\n        seriesField: ID_FIELD,\n        rawFields: [setsField, sizeField],\n        schema: {\n          shape: 'venn',\n          style: pointStyle,\n        },\n      },\n    })\n  );\n\n  const geometry = ext.geometry as Geometry;\n  geometry.customInfo(customInfo);\n\n  const colorOptions = transformColor(params, vennData);\n  // 韦恩图试点, color 通道只能映射一个字段. 通过外部查找获取 datum\n  if (typeof colorOptions === 'function') {\n    geometry.color(ID_FIELD, (id) => {\n      const datum = vennData.find((d) => d[ID_FIELD] === id);\n      const defaultColor = colorMap(params, vennData)(id);\n      return colorOptions(datum, defaultColor);\n    });\n  }\n\n  return params;\n}\n\n/**\n * 处理 label\n * @param params\n */\nfunction label(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart, options } = params;\n  const { label } = options;\n\n  // 获取容器大小\n  const [t, , , l] = normalPadding(chart.appendPadding);\n  // 传入 label 布局函数所需的 自定义参数\n  const customLabelInfo = { offsetX: l, offsetY: t };\n\n  const geometry = findGeometry(chart, 'schema');\n\n  if (!label) {\n    geometry.label(false);\n  } else {\n    const { callback, ...cfg } = label;\n    geometry.label({\n      fields: ['id'],\n      callback,\n      cfg: deepMix({}, transformLabel(cfg), {\n        // 使用 G2 的 自定义label 修改位置\n        type: 'venn',\n        customLabelInfo,\n      }),\n    });\n  }\n\n  return params;\n}\n\n/**\n * legend 配置\n * @param params\n */\nexport function legend(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart, options } = params;\n  const { legend, sizeField } = options;\n\n  chart.legend(ID_FIELD, legend);\n  // 强制不开启 连续图例\n  chart.legend(sizeField, false);\n\n  return params;\n}\n\n/**\n * 默认关闭坐标轴\n * @param params\n */\nexport function axis(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart } = params;\n  chart.axis(false);\n\n  return params;\n}\n\n/**\n * 韦恩图 interaction 交互适配器\n */\nfunction vennInteraction(params: Params<VennOptions>): Params<VennOptions> {\n  const { options, chart } = params;\n  const { interactions } = options;\n\n  if (interactions) {\n    const MAP = {\n      'legend-active': 'venn-legend-active',\n      'legend-highlight': 'venn-legend-highlight',\n    };\n    interaction(\n      deepAssign({}, params, {\n        options: {\n          interactions: interactions.map((i) => ({\n            ...i,\n            type: MAP[i.type] || i.type,\n          })),\n        },\n      })\n    );\n  }\n\n  chart.removeInteraction('legend-active');\n  chart.removeInteraction('legend-highlight');\n  return params;\n}\n\n/**\n * 图适配器\n * @param chart\n * @param options\n */\nexport function adaptor(params: Params<VennOptions>) {\n  // flow 的方式处理所有的配置到 G2 API\n  return flow(\n    padding,\n    theme,\n    data,\n    geometry,\n    label,\n    scale({}),\n    legend,\n    axis,\n    tooltip,\n    vennInteraction,\n    animation\n    // ... 其他的 adaptor flow\n  )(params);\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}